import{_ as a,o as n,c as i,ag as l}from"./chunks/framework.C63nTIu3.js";const o=JSON.parse('{"title":"主从复制与高可用面试题","description":"","frontmatter":{"title":"主从复制与高可用面试题"},"headers":[],"relativePath":"interview/database/intermediate/replication.md","filePath":"interview/database/intermediate/replication.md","lastUpdated":1770797811000}'),p={name:"interview/database/intermediate/replication.md"};function e(t,s,r,h,d,k){return n(),i("div",null,[...s[0]||(s[0]=[l(`<h1 id="主从复制与高可用面试题" tabindex="-1">主从复制与高可用面试题 <a class="header-anchor" href="#主从复制与高可用面试题" aria-label="Permalink to &quot;主从复制与高可用面试题&quot;">​</a></h1><blockquote><p><strong>难度等级</strong>：⭐⭐⭐ | <strong>出现频率</strong>：75% | <strong>建议用时</strong>：30分钟</p></blockquote><h2 id="mysql主从复制题" tabindex="-1">MySQL主从复制题 <a class="header-anchor" href="#mysql主从复制题" aria-label="Permalink to &quot;MySQL主从复制题&quot;">​</a></h2><h3 id="_1-mysql主从复制原理" tabindex="-1">1. MySQL主从复制原理？ <a class="header-anchor" href="#_1-mysql主从复制原理" aria-label="Permalink to &quot;1. MySQL主从复制原理？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><p><strong>复制类型</strong>：</p><p><strong>1. 异步复制（Asynchronous）</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>主库 -&gt; binlog -&gt; 从库IO线程 -&gt; Relay Log -&gt; SQL线程执行</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ul><li>主库不等待从库确认</li><li>性能最好，但可能丢失数据</li><li>默认模式</li></ul><p><strong>2. 半同步复制（Semisynchronous）</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>主库 -&gt; binlog -&gt; 从库</span></span>
<span class="line"><span>从库ACK -&gt; 主库（至少一个从库确认）</span></span>
<span class="line"><span>主库 -&gt; commit</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>主库等待至少一个从库接收</li><li>平衡性能和数据安全</li><li>需要安装插件</li></ul><p><strong>3. 全同步复制（Synchronous）</strong></p><ul><li>主库等待所有从库确认</li><li>数据最安全，但性能最差</li><li>很少使用</li></ul><p><strong>复制流程</strong>：</p><ol><li><strong>主库</strong>：记录数据变更到binlog</li><li><strong>从库IO线程</strong>：请求binlog并写入Relay Log</li><li><strong>从库SQL线程</strong>：读取Relay Log并执行</li></ol><hr><h3 id="_2-binlog三种格式区别" tabindex="-1">2. binlog三种格式区别？ <a class="header-anchor" href="#_2-binlog三种格式区别" aria-label="Permalink to &quot;2. binlog三种格式区别？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><table tabindex="0"><thead><tr><th>格式</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Statement</strong></td><td>日志量小</td><td>不安全（函数、触发器可能不一致）</td><td>简单应用</td></tr><tr><td><strong>Row</strong></td><td>最安全，精确记录</td><td>日志量大，无法看执行了什么SQL</td><td>数据恢复、主从</td></tr><tr><td><strong>Mixed</strong></td><td>平衡</td><td>混合模式可能有问题</td><td>一般场景</td></tr></tbody></table><p><strong>查看格式</strong>：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SHOW VARIABLES </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LIKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;binlog_format&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>设置格式</strong>：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> binlog_format </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ROW&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><hr><h3 id="_3-主从延迟如何解决" tabindex="-1">3. 主从延迟如何解决？ <a class="header-anchor" href="#_3-主从延迟如何解决" aria-label="Permalink to &quot;3. 主从延迟如何解决？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><p><strong>原因分析</strong>：</p><ul><li>从库配置低（单线程应用）</li><li>网络延迟</li><li>从库负载高</li><li>大事务</li><li>锁冲突</li></ul><p><strong>解决方案</strong>：</p><p><strong>1. 并行复制（MySQL 5.7+）</strong></p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 从库设置并行复制</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 基于库并行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> slave_parallel_workers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> slave_parallel_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;DATABASE&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 基于 INFORMATION_SCHEMA_SERVERS</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 需要配置主库信息</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>2. 多线程复制（MySQL 8.0+）</strong></p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 设置并行复制线程数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replica_parallel_workers </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 并行类型</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- LOGICAL_CLOCK: 基于逻辑时钟顺序</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- DATABASE: 基于数据库</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>3. 读写分离</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 写操作走主库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">masterDB.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">executeUpdate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sql);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 读操作走从库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">List&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Data</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; results </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> slaveDB.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">query</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sql);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 使用中间件</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// - MySQL Router</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// - ProxySQL</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// - ShardingSphere</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// - MyCat</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>4. 延迟监控</strong></p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看延迟</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SHOW SLAVE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\G</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Seconds_Behind_Master: 延迟秒数</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- MySQL 8.0+</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">REPLICA</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr><h2 id="gtid题" tabindex="-1">GTID题 <a class="header-anchor" href="#gtid题" aria-label="Permalink to &quot;GTID题&quot;">​</a></h2><h3 id="_4-什么是gtid-有什么优势" tabindex="-1">4. 什么是GTID？有什么优势？ <a class="header-anchor" href="#_4-什么是gtid-有什么优势" aria-label="Permalink to &quot;4. 什么是GTID？有什么优势？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><p><strong>GTID（Global Transaction ID）</strong>：全局事务ID</p><p><strong>格式</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>source_id:transaction_id</span></span>
<span class="line"><span>例如：3E11FA47-71CA-11E1-9075-9A5FD1E5A:23</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>优势</strong>：</p><p><strong>1. 简化主从切换</strong></p><ul><li>不需要查找binlog文件和位置</li><li>直接通过GTID定位</li></ul><p><strong>2. 多源复制</strong></p><ul><li>从库可以有多主库</li><li>合并多个主库的GTID</li></ul><p><strong>3. 防止重复执行</strong></p><ul><li>已执行的GTID会被跳过</li></ul><p><strong>4. 故障恢复简单</strong></p><ul><li>不需要计算binlog位置</li></ul><p><strong>开启GTID</strong>：</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 主库</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gtid_mode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> enforce_gtid_consistency </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 从库</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> gtid_mode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHANGE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  MASTER_HOST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;master_ip&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  MASTER_AUTO_POSITION </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><hr><h2 id="高可用架构题" tabindex="-1">高可用架构题 <a class="header-anchor" href="#高可用架构题" aria-label="Permalink to &quot;高可用架构题&quot;">​</a></h2><h3 id="_5-mysql高可用方案有哪些" tabindex="-1">5. MySQL高可用方案有哪些？ <a class="header-anchor" href="#_5-mysql高可用方案有哪些" aria-label="Permalink to &quot;5. MySQL高可用方案有哪些？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><p><strong>1. 传统主从 + Keepalived</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Master (Active) VIP</span></span>
<span class="line"><span>    |</span></span>
<span class="line"><span>    +-- +VIP浮动</span></span>
<span class="line"><span>Slave (Standby) VIP</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>VIP浮动到可用节点</li><li>故障切换需要手动或脚本</li><li>可能数据丢失</li></ul><p><strong>2. MHA（Master High Availability）</strong></p><ul><li>自动故障检测和切换</li><li>提供VIP管理</li><li>数据补偿机制</li><li>已停止维护（推荐Orchestrator）</li></ul><p><strong>3. MGR（MySQL Group Replication）</strong></p><ul><li>多主复制架构</li><li>基于Paxos协议</li><li>最多9个节点</li><li>强一致性</li></ul><p><strong>4. InnoDB Cluster</strong></p><ul><li>多主架构</li><li>数据自动分片（NDB）</li><li>无共享存储</li><li>实时同步</li></ul><hr><h3 id="_6-mgr-vs-传统主从" tabindex="-1">6. MGR vs 传统主从？ <a class="header-anchor" href="#_6-mgr-vs-传统主从" aria-label="Permalink to &quot;6. MGR vs 传统主从？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><table tabindex="0"><thead><tr><th>特性</th><th>传统主从</th><th>MGR</th></tr></thead><tbody><tr><td>复制模式</td><td>异步/半同步</td><td>基于Paxos的组复制</td></tr><tr><td>主库数量</td><td>单主</td><td>多主（最多9节点）</td></tr><tr><td>一致性</td><td>最终一致性</td><td>强一致性</td></tr><tr><td>切换</td><td>需要外部工具</td><td>自动选举</td></tr><tr><td>冲突处理</td><td>无</td><td>自动检测和解决</td></tr><tr><td>适用版本</td><td>所有版本</td><td>MySQL 5.7.17+</td></tr></tbody></table><p><strong>MGR使用场景</strong>：</p><ul><li>多地多活</li><li>就近访问</li><li>高可用要求</li></ul><hr><h2 id="postgresql复制题" tabindex="-1">PostgreSQL复制题 <a class="header-anchor" href="#postgresql复制题" aria-label="Permalink to &quot;PostgreSQL复制题&quot;">​</a></h2><h3 id="_7-postgresql复制方式有哪些" tabindex="-1">7. PostgreSQL复制方式有哪些？ <a class="header-anchor" href="#_7-postgresql复制方式有哪些" aria-label="Permalink to &quot;7. PostgreSQL复制方式有哪些？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><p><strong>1. 流复制（Streaming Replication）</strong></p><ul><li>主库：WAL日志</li><li>从库：恢复WAL</li><li>支持级联复制</li></ul><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 主库创建复制槽</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pg_create_physical_replication_slot(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;slot_name&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 从库基础备份</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pg_basebackup </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">master</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/backup/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">base</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 从库恢复并启动</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">pg_ctl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">start</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/data</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>2. 逻辑复制</strong></p><ul><li>基于触发器或日志解析</li><li>支持部分表复制</li><li>可以跨版本</li></ul><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 安装pglogical扩展</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> EXTENSION pglogical;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建节点</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pglogical</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">create_node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(...);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 订阅表</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> pglogical</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">subscribe_table</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(...);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>3. BDR（Bidirectional Replication）</strong></p><ul><li>双向复制</li><li>多主多写</li><li>冲突解决</li></ul><hr><h2 id="redis高可用题" tabindex="-1">Redis高可用题 <a class="header-anchor" href="#redis高可用题" aria-label="Permalink to &quot;Redis高可用题&quot;">​</a></h2><h3 id="_8-redis哨兵原理" tabindex="-1">8. Redis哨兵原理？ <a class="header-anchor" href="#_8-redis哨兵原理" aria-label="Permalink to &quot;8. Redis哨兵原理？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><p><strong>Sentinel架构</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Master</span></span>
<span class="line"><span>   |  (PUBLISH心跳)</span></span>
<span class="line"><span>   +--+</span></span>
<span class="line"><span>Sentinel1  Sentinel2  Sentinel3 (监控、选举、通知)</span></span>
<span class="line"><span>   |             |</span></span>
<span class="line"><span>Slave1  Slave2  (数据同步)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>Sentinel功能</strong>：</p><p><strong>1. 监控</strong></p><ul><li>持续ping主从节点</li><li>检查是否主观下线（sdown）</li><li>检查是否客观下线（odown）</li></ul><p><strong>2. 通知</strong></p><ul><li>节点故障时通知管理员</li><li>通过脚本、API通知</li></ul><p><strong>3. 自动故障转移</strong></p><ul><li>选举哨兵leader</li><li>自动提升从库为新主库</li><li>配置客户端连接到新主库</li></ul><p><strong>4. 配置提供者</strong></p><ul><li>新主库IP告知客户端</li><li>客户端使用Sentinel获取主库地址</li></ul><p><strong>配置示例</strong>：</p><div class="language-conf vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>port 26379</span></span>
<span class="line"><span>sentinel monitor mymaster 127.0.0.1 6379 2</span></span>
<span class="line"><span>sentinel down-after-milliseconds mymaster 5000</span></span>
<span class="line"><span>sentinel parallel-syncs mymaster 1</span></span>
<span class="line"><span>sentinel failover-timeout mymaster 60000</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><hr><h3 id="_9-redis-cluster原理" tabindex="-1">9. Redis Cluster原理？ <a class="header-anchor" href="#_9-redis-cluster原理" aria-label="Permalink to &quot;9. Redis Cluster原理？&quot;">​</a></h3><p><strong>参考答案</strong>：</p><p><strong>Redis Cluster架构</strong>：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Client</span></span>
<span class="line"><span>  |</span></span>
<span class="line"><span>  +---&gt; 路由槽(0-16383)</span></span>
<span class="line"><span>  |</span></span>
<span class="line"><span>[node1][node2][node3][node4]...</span></span>
<span class="line"><span>  槽位分配: 槽0-5460 | 槽5461-10922 | ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>核心概念</strong>：</p><p><strong>1. 槽位（Slot）</strong></p><ul><li>16384个哈希槽</li><li>每个键计算槽位：CRC16(key) % 16384</li></ul><p><strong>2. 槽位分配</strong></p><ul><li>槽位分配到不同节点</li><li>支持在线迁移槽位</li></ul><p><strong>3. 跳跃表</strong></p><ul><li>节点内部使用跳跃表</li><li>快速定位槽位所在的节点</li></ul><p><strong>4. Gossip协议</strong></p><ul><li>节点间交换状态</li><li>检测节点故障</li></ul><p><strong>优点</strong>：</p><ul><li>自动分片</li><li>高可用（主从）</li><li>水平扩展</li></ul><p><strong>缺点</strong>：</p><ul><li>多键操作受限</li><li>事务支持受限</li><li>需要特殊客户端</li></ul><hr><h2 id="实战场景题" tabindex="-1">实战场景题 <a class="header-anchor" href="#实战场景题" aria-label="Permalink to &quot;实战场景题&quot;">​</a></h2><h3 id="_10-设计一个高可用数据库架构" tabindex="-1">10. 设计一个高可用数据库架构 <a class="header-anchor" href="#_10-设计一个高可用数据库架构" aria-label="Permalink to &quot;10. 设计一个高可用数据库架构&quot;">​</a></h3><p><strong>参考答案</strong>：</p><p><strong>方案1：MHA + VIP</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>应用 -&gt; VIP -&gt; [Master-A, Master-B]</span></span>
<span class="line"><span>                   |</span></span>
<span class="line"><span>                   v</span></span>
<span class="line"><span>              [Slave-1, Slave-2, Slave-3]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>特点：</span></span>
<span class="line"><span>- 双主热备</span></span>
<span class="line"><span>- 自动故障切换</span></span>
<span class="line"><span>- 读请求可以走从库</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>方案2：MGR多主</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>应用 -&gt; ProxySQL -&gt; [MGR-Node1, MGR-Node2, MGR-Node3]</span></span>
<span class="line"><span>                              |</span></span>
<span class="line"><span>                              v</span></span>
<span class="line"><span>                    [Primary election]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>特点：</span></span>
<span class="line"><span>- 多主多写</span></span>
<span class="line"><span>- 自动故障转移</span></span>
<span class="line"><span>- 强一致性</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>方案3：读写分离</strong></p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 配置数据源</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Configuration</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> DataSourceConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Primary</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DataSource </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">masterDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 写主库</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DataSourceBuilder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(masterConfig);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DataSource </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">slaveDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 读从库（轮询负载）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DataSourceBuilder.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">create</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(slaveConfig);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DataSource </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dynamicDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 路由：写-&gt;主库，读-&gt;从库</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> RoutingDataSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(master, slaves);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><strong>选择建议</strong>：</p><ul><li>读写分离：简单场景</li><li>MHA：传统应用改造小</li><li>MGR：新应用、多地多活</li></ul><hr><p><strong>更新时间</strong>：2026年2月 | <strong>版本</strong>：v1.0</p>`,136)])])}const g=a(p,[["render",e]]);export{o as __pageData,g as default};
