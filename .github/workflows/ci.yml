name: CI æ£€æŸ¥

on:
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  lint-and-test:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: æ„å»ºæ£€æŸ¥
        name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: pnpm docs:build

      - name: é“¾æ¥æ£€æŸ¥
        name: ğŸ” æ£€æŸ¥æ–­å¼€çš„é“¾æ¥
        run: |
          echo "æ£€æŸ¥æ–‡æ¡£é“¾æ¥å®Œæ•´æ€§..."
          # TODO: æ·»åŠ é“¾æ¥æ£€æŸ¥å·¥å…·
          exit 0

  commit-lint:
    name: æäº¤ä¿¡æ¯æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼
        run: |
          echo "æ£€æŸ¥ PR çš„æäº¤ä¿¡æ¯..."
          # è·å– PR çš„æ‰€æœ‰æäº¤
          COMMITS=$(git log --format=%s origin/main..HEAD)

          # æ£€æŸ¥æ¯ä¸ªæäº¤æ˜¯å¦ç¬¦åˆè§„èŒƒ
          while IFS= read -r commit; do
            echo "æ£€æŸ¥æäº¤: $commit"

            # æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ ¼å¼ï¼štype(scope): description
            if [[ ! $commit =~ ^(feat|fix|docs|style|refactor|test|chore|perf)\(.*\): .+ ]]; then
              echo "âŒ æäº¤ä¿¡æ¯æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
              echo "æœŸæœ›æ ¼å¼: type(scope): description"
              echo "ç¤ºä¾‹: feat(ç”¨æˆ·): æ·»åŠ ç™»å½•åŠŸèƒ½"
              exit 1
            fi

            echo "âœ… æäº¤ä¿¡æ¯æ ¼å¼æ­£ç¡®"
          done <<< "$COMMITS"

  changes-lint:
    name: æ–‡ä»¶å˜æ›´æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
        run: |
          echo "æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæ–‡ä»¶è¢«æäº¤..."

          # è·å–å˜æ›´çš„æ–‡ä»¶
          FILES=$(git diff --name-only origin/main...HEAD)

          # æ•æ„Ÿæ–‡ä»¶åˆ—è¡¨
          SENSITIVE_FILES=(
            ".env"
            ".env.local"
            "*.key"
            "*.pem"
            "password"
            "secret"
            "credentials.json"
          )

          # æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæ–‡ä»¶
          for file in $FILES; do
            for sensitive in "${SENSITIVE_FILES[@]}"; do
              if [[ $file == $sensitive ]]; then
                echo "âŒ æ£€æµ‹åˆ°æ•æ„Ÿæ–‡ä»¶: $file"
                echo "è¯·ç«‹å³ä»æäº¤ä¸­ç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼"
                exit 1
              fi
            done
          done

          echo "âœ… æœªå‘ç°æ•æ„Ÿæ–‡ä»¶"

      - name: æ£€æŸ¥å¤§æ–‡ä»¶
        run: |
          echo "æ£€æŸ¥æ˜¯å¦æœ‰å¤§æ–‡ä»¶è¢«æäº¤..."

          # è·å–å˜æ›´çš„æ–‡ä»¶
          FILES=$(git diff --name-only origin/main...HEAD)

          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          for file in $FILES; do
            if [ -f "$file" ]; then
              SIZE=$(du -b "$file" | cut -f1)
              # å¤§äº 5MB
              if [ $SIZE -gt 5242880 ]; then
                echo "âš ï¸ æ£€æµ‹åˆ°å¤§æ–‡ä»¶: $file ($(du -h "$file" | cut -f1))"
                echo "å¤§æ–‡ä»¶åº”è¯¥ä½¿ç”¨ Git LFS æˆ–å…¶ä»–æ–¹å¼ç®¡ç†"
              fi
            fi
          done

          echo "âœ… æ–‡ä»¶å¤§å°æ£€æŸ¥å®Œæˆ"

  pr-title-check:
    name: PR æ ‡é¢˜æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: æ£€æŸ¥ PR æ ‡é¢˜
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "PR æ ‡é¢˜: $TITLE"

          # æ£€æŸ¥ PR æ ‡é¢˜æ˜¯å¦ç¬¦åˆè§„èŒƒ
          if [[ ! $TITLE =~ ^(feat|fix|docs|style|refactor|test|chore|perf)\(.*\): .+ ]]; then
            echo "âŒ PR æ ‡é¢˜æ ¼å¼ä¸ç¬¦åˆè§„èŒƒ"
            echo "æœŸæœ›æ ¼å¼: type(scope): description"
            echo "ç¤ºä¾‹: feat(AIæ¨¡å—): æ·»åŠ  Agent Skills ç« èŠ‚"
            echo ""
            echo "å…è®¸çš„ç±»å‹:"
            echo "  - feat: æ–°åŠŸèƒ½"
            echo "  - fix: ä¿®å¤bug"
            echo "  - docs: æ–‡æ¡£æ›´æ–°"
            echo "  - style: ä»£ç æ ¼å¼"
            echo "  - refactor: é‡æ„"
            echo "  - test: æµ‹è¯•"
            echo "  - chore: æ„å»º/å·¥å…·"
            echo "  - perf: æ€§èƒ½ä¼˜åŒ–"
            exit 1
          fi

          echo "âœ… PR æ ‡é¢˜æ ¼å¼æ­£ç¡®"
