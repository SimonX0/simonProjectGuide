# é”™è¯¯å¤„ç†ä¸åŠ è½½çŠ¶æ€

## é”™è¯¯å¤„ç†ä¸åŠ è½½çŠ¶æ€

> **å­¦ä¹ ç›®æ ‡**ï¼šæŒæ¡Next.jsçš„é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€ç®¡ç†ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
> **æ ¸å¿ƒå†…å®¹**ï¼šerror.jsã€loading.jsã€Error Boundariesã€åŠ è½½çŠ¶æ€ä¼˜åŒ–ã€å®æˆ˜æ¡ˆä¾‹

### é”™è¯¯å¤„ç†ç³»ç»Ÿ

#### Next.jsé”™è¯¯å¤„ç†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Next.js é”™è¯¯å¤„ç†å±‚çº§                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å…¨å±€çº§åˆ« (root error.tsx)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ æ•è·æ‰€æœ‰æœªå¤„ç†çš„é”™è¯¯                              â”‚   â”‚
â”‚  â”‚  â€¢ å¿…é¡»æ˜¯Client Component                            â”‚   â”‚
â”‚  â”‚  â€¢ æ˜¾ç¤ºå¤‡ç”¨UI                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                                               â”‚
â”‚  è·¯ç”±çº§åˆ« (app/*/error.tsx)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ æ•è·ç‰¹å®šè·¯ç”±çš„é”™è¯¯                                â”‚   â”‚
â”‚  â”‚  â€¢ å¯ä»¥åµŒå¥—                                         â”‚   â”‚
â”‚  â”‚  â€¢ æä¾›é‡è¯•åŠŸèƒ½                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                                               â”‚
â”‚  ç»„ä»¶çº§åˆ« (Error Boundaries)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ æ•è·å­ç»„ä»¶çš„é”™è¯¯                                  â”‚   â”‚
â”‚  â”‚  â€¢ ä½¿ç”¨React Error Boundaries                       â”‚   â”‚
â”‚  â”‚  â€¢ å±€éƒ¨é”™è¯¯éš”ç¦»                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### error.js

#### 1. å…¨å±€é”™è¯¯å¤„ç†

```typescript
// app/error.tsx
'use client' // å¿…é¡»æ˜¯Client Component

import { useEffect } from 'react'
import { Button } from '@/components/ui/button'

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    // è®°å½•é”™è¯¯åˆ°é”™è¯¯æŠ¥å‘ŠæœåŠ¡
    console.error('Global error:', error)
  }, [error])

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full">
        <div className="text-center">
          {/* Error Icon */}
          <div className="flex justify-center mb-6">
            <div className="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center">
              <svg
                className="w-10 h-10 text-red-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                />
              </svg>
            </div>
          </div>

          {/* Error Message */}
          <h1 className="text-3xl font-bold text-gray-900 mb-2">
            å‡ºé”™äº†
          </h1>
          <p className="text-gray-600 mb-8">
            {error.message || 'é¡µé¢åŠ è½½æ—¶å‘ç”Ÿé”™è¯¯'}
          </p>

          {/* Error Digest (ç”Ÿäº§ç¯å¢ƒ) */}
          {process.env.NODE_ENV === 'production' && error.digest && (
            <p className="text-xs text-gray-500 mb-8">
              é”™è¯¯ä»£ç : {error.digest}
            </p>
          )}

          {/* Actions */}
          <div className="flex flex-col gap-3">
            <Button onClick={reset} className="w-full">
              é‡è¯•
            </Button>
            <Button
              variant="outline"
              onClick={() => (window.location.href = '/')}
              className="w-full"
            >
              è¿”å›é¦–é¡µ
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}
```

#### 2. è·¯ç”±çº§é”™è¯¯å¤„ç†

```typescript
// app/dashboard/error.tsx
'use client'

import { Button } from '@/components/ui/button'

export default function DashboardError({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
      <div className="max-w-lg w-full bg-white rounded-lg shadow-lg p-8">
        {/* Header */}
        <div className="text-center mb-6">
          <h2 className="text-2xl font-bold text-gray-900 mb-2">
            ä»ªè¡¨ç›˜åŠ è½½å¤±è´¥
          </h2>
          <p className="text-gray-600">
            {error.message || 'æ— æ³•åŠ è½½ä»ªè¡¨ç›˜æ•°æ®'}
          </p>
        </div>

        {/* Error Details (å¼€å‘ç¯å¢ƒ) */}
        {process.env.NODE_ENV === 'development' && (
          <details className="mb-6">
            <summary className="cursor-pointer text-sm font-medium text-gray-700 mb-2">
              é”™è¯¯è¯¦æƒ…
            </summary>
            <pre className="bg-gray-100 p-4 rounded text-xs overflow-auto">
              {error.stack}
            </pre>
          </details>
        )}

        {/* Actions */}
        <div className="flex gap-3">
          <Button onClick={reset} className="flex-1">
            é‡è¯•
          </Button>
          <Button
            variant="outline"
            onClick={() => window.location.reload()}
            className="flex-1"
          >
            åˆ·æ–°é¡µé¢
          </Button>
        </div>
      </div>
    </div>
  )
}
```

#### 3. ç‰¹å®šç±»å‹é”™è¯¯å¤„ç†

```typescript
// app/blog/[slug]/error.tsx
'use client'

import Link from 'next/link'
import { Button } from '@/components/ui/button'

export default function BlogPostError({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
  const getErrorMessage = () => {
    if (error.message.includes('not found')) {
      return 'æ–‡ç« æœªæ‰¾åˆ°'
    }
    if (error.message.includes('unauthorized')) {
      return 'æ‚¨æ²¡æœ‰æƒé™æŸ¥çœ‹æ­¤æ–‡ç« '
    }
    return 'æ–‡ç« åŠ è½½å¤±è´¥'
  }

  return (
    <div className="max-w-4xl mx-auto px-4 py-16">
      <div className="text-center">
        <div className="text-6xl mb-4">ğŸ˜•</div>
        <h1 className="text-3xl font-bold text-gray-900 mb-4">
          {getErrorMessage()}
        </h1>
        <p className="text-gray-600 mb-8">
          {error.message}
        </p>

        <div className="flex justify-center gap-4">
          <Button onClick={reset}>é‡è¯•</Button>
          <Link href="/blog">
            <Button variant="outline">è¿”å›åšå®¢åˆ—è¡¨</Button>
          </Link>
        </div>
      </div>
    </div>
  )
}
```

### loading.js

#### 1. å…¨å±€åŠ è½½çŠ¶æ€

```typescript
// app/loading.tsx
export default function Loading() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="text-center">
        {/* Loading Spinner */}
        <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4" />

        {/* Loading Text */}
        <p className="text-gray-600">åŠ è½½ä¸­...</p>
      </div>
    </div>
  )
}
```

#### 2. è·¯ç”±çº§åŠ è½½çŠ¶æ€

```typescript
// app/dashboard/loading.tsx
export default function DashboardLoading() {
  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-7xl mx-auto">
        {/* Skeleton Header */}
        <div className="mb-8">
          <div className="h-8 bg-gray-200 rounded w-1/3 mb-4 animate-pulse" />
          <div className="h-4 bg-gray-200 rounded w-1/4 animate-pulse" />
        </div>

        {/* Skeleton Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          {[...Array(4)].map((_, i) => (
            <div key={i} className="bg-white rounded-lg shadow-sm p-6">
              <div className="h-4 bg-gray-200 rounded w-1/2 mb-4 animate-pulse" />
              <div className="h-8 bg-gray-200 rounded w-3/4 animate-pulse" />
            </div>
          ))}
        </div>

        {/* Skeleton Content */}
        <div className="bg-white rounded-lg shadow-sm p-6">
          <div className="h-4 bg-gray-200 rounded w-full mb-4 animate-pulse" />
          <div className="h-4 bg-gray-200 rounded w-5/6 mb-4 animate-pulse" />
          <div className="h-4 bg-gray-200 rounded w-4/6 animate-pulse" />
        </div>
      </div>
    </div>
  )
}
```

#### 3. ç»„ä»¶çº§åŠ è½½çŠ¶æ€

```typescript
// components/DataTable.tsx
'use client'

import { useState, useEffect } from 'react'

interface DataTableProps {
  fetchData: () => Promise<any[]>
}

export default function DataTable({ fetchData }: DataTableProps) {
  const [data, setData] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    async function loadData() {
      try {
        setLoading(true)
        const result = await fetchData()
        setData(result)
      } catch (err) {
        setError(err instanceof Error ? err.message : 'åŠ è½½æ•°æ®å¤±è´¥')
      } finally {
        setLoading(false)
      }
    }

    loadData()
  }, [fetchData])

  if (loading) {
    return <DataTableSkeleton />
  }

  if (error) {
    return <DataTableError error={error} />
  }

  return <DataTableContent data={data} />
}

function DataTableSkeleton() {
  return (
    <div className="space-y-3">
      {[...Array(5)].map((_, i) => (
        <div key={i} className="h-16 bg-gray-200 rounded animate-pulse" />
      ))}
    </div>
  )
}

function DataTableError({ error }: { error: string }) {
  return (
    <div className="p-4 bg-red-50 text-red-700 rounded-lg">
      {error}
    </div>
  )
}

function DataTableContent({ data }: { data: any[] }) {
  return (
    <div className="space-y-3">
      {data.map((item, i) => (
        <div key={i} className="p-4 bg-white rounded-lg shadow-sm">
          {item.name}
        </div>
      ))}
    </div>
  )
}
```

### Error Boundaries

#### 1. React Error Boundary

```typescript
// components/ErrorBoundary.tsx
'use client'

import React, { Component, ReactNode } from 'react'
import { Button } from '@/components/ui/button'

interface Props {
  children: ReactNode
  fallback?: ReactNode
  onError?: (error: Error, errorInfo: React.ErrorInfo) => void
}

interface State {
  hasError: boolean
  error: Error | null
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props)
    this.state = { hasError: false, error: null }
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error }
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    // è®°å½•é”™è¯¯
    console.error('ErrorBoundary caught an error:', error, errorInfo)

    // è°ƒç”¨è‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨
    if (this.props.onError) {
      this.props.onError(error, errorInfo)
    }
  }

  render() {
    if (this.state.hasError) {
      return (
        this.props.fallback || (
          <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
            <div className="max-w-md w-full text-center">
              <div className="text-6xl mb-4">âš ï¸</div>
              <h2 className="text-2xl font-bold text-gray-900 mb-2">
                ç»„ä»¶åŠ è½½å¤±è´¥
              </h2>
              <p className="text-gray-600 mb-6">
                {this.state.error?.message || 'å‘ç”ŸæœªçŸ¥é”™è¯¯'}
              </p>
              <Button
                onClick={() => this.setState({ hasError: false, error: null })}
              >
                é‡è¯•
              </Button>
            </div>
          </div>
        )
      )
    }

    return this.props.children
  }
}
```

#### 2. ä½¿ç”¨Error Boundary

```typescript
// app/dashboard/page.tsx
import ErrorBoundary from '@/components/ErrorBoundary'
import RiskyComponent from '@/components/RiskyComponent'

export default function DashboardPage() {
  return (
    <div>
      <h1>ä»ªè¡¨ç›˜</h1>

      {/* ç”¨ErrorBoundaryåŒ…è£¹å¯èƒ½å‡ºé”™çš„ç»„ä»¶ */}
      <ErrorBoundary
        onError={(error, errorInfo) => {
          // å‘é€åˆ°é”™è¯¯æŠ¥å‘ŠæœåŠ¡
          reportError(error, errorInfo)
        }}
      >
        <RiskyComponent />
      </ErrorBoundary>
    </div>
  )
}
```

### å®æˆ˜æ¡ˆä¾‹ï¼šä¼˜é›…çš„é”™è¯¯å¤„ç†

åˆ›å»ºä¸€ä¸ªåŒ…å«å¤šç§é”™è¯¯å¤„ç†åœºæ™¯çš„å®Œæ•´åº”ç”¨ã€‚

#### 1. å¸¦é‡è¯•çš„æ•°æ®è·å–

```typescript
// lib/fetchWithRetry.ts
export async function fetchWithRetry<T>(
  fetcher: () => Promise<T>,
  options: {
    retries?: number
    delay?: number
    onRetry?: (error: Error, attempt: number) => void
  } = {}
): Promise<T> {
  const { retries = 3, delay = 1000, onRetry } = options

  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      return await fetcher()
    } catch (error) {
      const isLastAttempt = attempt === retries

      if (isLastAttempt) {
        throw error
      }

      if (onRetry && error instanceof Error) {
        onRetry(error, attempt)
      }

      // æŒ‡æ•°é€€é¿
      await new Promise(resolve =>
        setTimeout(resolve, delay * Math.pow(2, attempt - 1))
      )
    }
  }

  throw new Error('Maximum retries exceeded')
}
```

#### 2. å¸¦åŠ è½½çŠ¶æ€çš„æŒ‰é’®

```typescript
// components/LoadingButton.tsx
'use client'

import { Button } from '@/components/ui/button'
import { useFormStatus } from 'react-dom'

interface LoadingButtonProps {
  children: React.ReactNode
  loadingText?: string
}

export function LoadingButton({ children, loadingText = 'å¤„ç†ä¸­...' }: LoadingButtonProps) {
  const { pending } = useFormStatus()

  return (
    <Button disabled={pending} type="submit">
      {pending ? (
        <span className="flex items-center">
          <svg
            className="animate-spin -ml-1 mr-3 h-5 w-5"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              className="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              strokeWidth="4"
            />
            <path
              className="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            />
          </svg>
          {loadingText}
        </span>
      ) : (
        children
      )}
    </Button>
  )
}
```

#### 3. æœåŠ¡å™¨æ“ä½œåŒ…è£…å™¨

```typescript
// lib/withErrorHandling.ts
'use server'

import { revalidatePath } from 'next/cache'

type ActionFunction<T> = (formData: FormData) => Promise<T>

export function withErrorHandling<T>(
  action: ActionFunction<T>,
  options: {
    revalidatePaths?: string[]
    errorMessage?: string
  } = {}
): ActionFunction<T | { error: string }> {
  return async (formData: FormData) => {
    try {
      const result = await action(formData)

      // é‡æ–°éªŒè¯è·¯å¾„
      if (options.revalidatePaths) {
        options.revalidatePaths.forEach(path => revalidatePath(path))
      }

      return result
    } catch (error) {
      console.error('Action error:', error)

      // è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
      if (error instanceof Error) {
        return {
          error: error.message || options.errorMessage || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        }
      }

      return {
        error: options.errorMessage || 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      }
    }
  }
}
```

### æœ€ä½³å®è·µ

#### 1. å§‹ç»ˆæä¾›åé¦ˆ

```typescript
// âœ… å¥½ï¼šæä¾›åŠ è½½å’Œé”™è¯¯çŠ¶æ€
'use client'

export default function DataList() {
  const [state, setState] = useState({
    data: null,
    loading: true,
    error: null,
  })

  if (state.loading) return <Loading />
  if (state.error) return <Error message={state.error} />
  return <List data={state.data} />
}

// âŒ å·®ï¼šæ²¡æœ‰åé¦ˆ
export default function DataList() {
  const [data, setData] = useState(null)
  return <div>{data && <List data={data} />}</div>
}
```

#### 2. ä½¿ç”¨éª¨æ¶å±

```typescript
// âœ… å¥½ï¼šä½¿ç”¨éª¨æ¶å±
export default function Loading() {
  return (
    <div>
      <div className="h-8 bg-gray-200 rounded w-1/3 mb-4 animate-pulse" />
      <div className="h-4 bg-gray-200 rounded w-2/3 animate-pulse" />
    </div>
  )
}

// âŒ å·®ï¼šåªæœ‰æ–‡å­—
export default function Loading() {
  return <div>åŠ è½½ä¸­...</div>
}
```

#### 3. é”™è¯¯å¯æ¢å¤

```typescript
// âœ… å¥½ï¼šæä¾›é‡è¯•é€‰é¡¹
export default function Error({ reset }: { reset: () => void }) {
  return (
    <div>
      <p>åŠ è½½å¤±è´¥</p>
      <button onClick={reset}>é‡è¯•</button>
    </div>
  )
}

// âŒ å·®ï¼šæ²¡æœ‰æ¢å¤é€‰é¡¹
export default function Error() {
  return <div>åŠ è½½å¤±è´¥</div>
}
```

### æœ¬ç« å°ç»“

| çŸ¥è¯†ç‚¹ | å†…å®¹ | æŒæ¡è¦æ±‚ |
|--------|------|---------|
| error.js | å…¨å±€å’Œè·¯ç”±çº§é”™è¯¯å¤„ç† | æŒæ¡å®ç°æ–¹æ³• |
| loading.js | åŠ è½½çŠ¶æ€å’Œéª¨æ¶å± | èƒ½å¤Ÿåˆ›å»º |
| Error Boundaries | ç»„ä»¶çº§é”™è¯¯éš”ç¦» | ç†è§£å¹¶åº”ç”¨ |
| æœ€ä½³å®è·µ | ç”¨æˆ·åé¦ˆã€é”™è¯¯æ¢å¤ | èƒ½å¤Ÿåº”ç”¨ |

---

**ä¸‹ä¸€æ­¥å­¦ä¹ **ï¼šå»ºè®®ç»§ç»­å­¦ä¹ [ç¼“å­˜ç­–ç•¥ä¸Revalidation](./chapter-96)äº†è§£ç¼“å­˜ç³»ç»Ÿã€‚
