# 第3章：Prompt Engineering技巧

## 本章导读

**Prompt Engineering（提示词工程）** 是AI应用开发中最重要的技能之一。好的提示词能让AI发挥出强大能力，而不好的提示词则会导致模糊、不准确的回答。

本章将系统介绍如何设计高效的提示词，让你的AI应用效果提升10倍！

**学习目标**：
- 理解Prompt Engineering的核心原则
- 掌握常用的提示词模式
- 学习Few-shot Learning技巧
- 实现高级提示词策略

**预计学习时间**：50分钟

---

## 3.1 什么是Prompt Engineering？

### 3.1.1 Prompt Engineering的定义

**Prompt Engineering** 是指通过设计和优化输入给大语言模型的提示词，以引导模型生成更准确、更相关、更符合预期的输出的技术。

```
┌─────────────────────────────────────────┐
│      Prompt Engineering 的价值            │
├─────────────────────────────────────────┤
│                                          │
│  ❌ 差的Prompt：                          │
│  "写个爬虫"                              │
│  → 结果：可能是网页爬虫、图片爬虫...       │
│                                          │
│  ✅ 好的Prompt：                          │
│  "请用Python写一个网页爬虫，要求：         │
│   - 使用requests库                        │
│   - 支持user-agent设置                    │
│   - 包含错误处理                          │
│   - 添加代码注释和使用示例"                │
│  → 结果：精确符合需求的代码               │
│                                          │
└─────────────────────────────────────────┘
```

### 3.1.2 为什么Prompt Engineering很重要？

| 方面 | 说明 |
|------|------|
| **效果提升** | 好的Prompt能让输出质量提升3-10倍 |
| **成本节约** | 精确的Prompt减少Token消耗 |
| **减少重试** | 一次得到满意结果，节省时间 |
| **可控性** | 让AI输出更符合你的预期 |
| **稳定性** | 一致的Prompt带来一致的输出 |

### 3.1.3 Prompt的基本结构

一个有效的Prompt通常包含以下要素：

```python
# 完整的Prompt结构
prompt = """
{角色设定}
你是一个专业的Python编程专家，擅长教学和代码优化。

{任务描述}
请解释Python装饰器的概念，并提供三个实际应用场景。

{输入数据}
无

{输出要求}
- 使用通俗易懂的语言
- 每个场景包含代码示例
- 总字数不超过500字

{约束条件}
- 不要涉及元类等高级概念
- 重点讲解使用场景而非语法细节
- 使用emoji增加可读性

{示例格式}
## 装饰器是什么
...

## 应用场景1：计时器
...
"""
```

---

## 3.2 Prompt设计的核心原则

### 3.2.1 原则1：清晰具体（Be Specific）

❌ **不好的示例**：
```python
prompt = "写一个爬虫"
```
问题：
- 什么类型的爬虫？
- 爬取什么数据？
- 用什么语言？

✅ **好的示例**：
```python
prompt = """
请用Python编写一个网页爬虫，具体要求：

目标网站：豆瓣电影Top250
需要提取：
  - 电影名称
  - 评分
  - 导演和主演
  - 一句话简介

技术要求：
  - 使用requests + BeautifulSoup
  - 添加适当的延时（随机2-5秒）
  - 包含异常处理
  - 数据保存为CSV格式

附加要求：
  - 添加详细注释
  - 提供使用示例
"""
```

### 3.2.2 原则2：提供上下文（Provide Context）

❌ **不好的示例**：
```python
prompt = "这段代码有什么问题？"
```

✅ **好的示例**：
```python
prompt = """
我是Python初学者，写了以下代码实现冒泡排序，但运行结果不对。

请帮我：
1. 指出代码中的问题
2. 解释为什么会这样
3. 提供修复后的代码
4. 给出避免此类问题的建议

代码：
```python
def bubble_sort(arr):
    n = len(arr)
    for i in range(n):
        for j in range(n):
            if arr[j] > arr[j+1]:
                arr[j], arr[j+1] = arr[j+1], arr[j]
    return arr

# 测试
print(bubble_sort([5, 2, 8, 1, 9]))
```
"""
```

### 3.2.3 原则3：明确输出格式（Specify Output Format）

❌ **不好的示例**：
```python
prompt = "分析这段文本的情感"
```

✅ **好的示例**：
```python
prompt = """
分析以下文本的情感倾向：

文本内容：今天天气真好，阳光明媚，心情特别棒！

请按以下格式输出：
```json
{
    "情感倾向": "正面/负面/中性",
    "情感强度": "强/中/弱",
    "关键词": ["关键词1", "关键词2"],
    "置信度": 0.95
}
```
"""
```

### 3.2.4 原则4：使用示例（Use Examples）

提供示例让AI更好地理解你的期望。

```python
prompt = """
任务：将以下Python函数转换为列表推导式

示例1：
输入：
```python
squares = []
for i in range(10):
    squares.append(i**2)
```

输出：
```python
squares = [i**2 for i in range(10)]
```

示例2：
输入：
```python
evens = []
for i in range(20):
    if i % 2 == 0:
        evens.append(i)
```

输出：
```python
evens = [i for i in range(20) if i % 2 == 0]
```

现在请转换以下代码：
【你的代码】
"""
```

### 3.2.5 原则5：设定角色（Assign a Role）

```python
# 角色化提示词效果更好
prompts = {
    "无角色": "解释什么是机器学习",

    "专家角色": """
    你是一位有10年经验的机器学习专家，曾在Google和Meta工作。
    请用通俗易懂的方式解释什么是机器学习，适合初学者理解。
    """,

    "老师角色": """
    你是一位大学计算机系教授，擅长用比喻和实例讲解复杂概念。
    请像给大一学生上课一样，解释什么是机器学习。
    """,

    "孩子角色": """
    你是一位小学科学老师，擅长用简单的语言和有趣的故事解释知识。
    请用5岁孩子能理解的方式解释什么是机器学习。
    """
}
```

---

## 3.3 常用提示词模式

### 3.3.1 模式1：思维链（Chain of Thought）

引导AI展示推理过程，提高复杂问题的准确率。

```python
# 基础版CoT
prompt = """
小明有5个苹果，他给了小红2个，又买了3个，吃掉了1个。
请问小明现在有几个苹果？

请一步步思考并给出答案。
"""

# AI输出：
"""
让我一步步计算：

1. 初始：小明有5个苹果
2. 给小红：5 - 2 = 3个
3. 买了3个：3 + 3 = 6个
4. 吃掉1个：6 - 1 = 5个

答案：小明现在有5个苹果
"""
```

### 3.3.2 模式2：Few-shot Learning

提供少量示例，让AI快速学习任务模式。

```python
# 情感分析Few-shot示例
prompt = """
任务：判断评论的情感倾向

示例1：
评论："这个产品太棒了，强烈推荐！"
标签：正面

示例2：
评论："质量很差，不推荐购买。"
标签：负面

示例3：
评论："一般般，凑合能用。"
标签：中性

现在请判断以下评论：
评论："超出预期，会继续支持！"
标签："""

# AI输出：正面
```

### 3.3.3 模式3：Self-Consistency（自洽性）

让AI多次生成答案，选择最一致的结果。

```python
# 实际应用中需要多次调用
prompt = """
用Python实现快速排序算法。

请提供3种不同的实现方式：
1. 递归版本
2. 使用列表推导式
3. 使用filter函数

每种方式都要包含：
- 完整代码
- 时间复杂度分析
- 优缺点说明
"""
```

### 3.3.4 模式4：Generate Then Refine先生成后优化

先生成初稿，再进行优化。

```python
# Step 1: 生成初稿
draft_prompt = """
写一篇介绍Python装饰器的文章，300字左右。
"""

# Step 2: 优化
refine_prompt = """
以下是关于Python装饰器的初稿：

【初稿内容】

请优化这篇文章：
1. 添加代码示例
2. 使用更生动的比喻
3. 添加常见应用场景
4. 总字数扩展到500字
5. 使用小标题分段
"""
```

### 3.3.5 模式5：Role Playing（角色扮演）

```python
# 技术面试
interview_prompt = """
你现在是Google的技术面试官，正在面试一位Python工程师。

请根据以下JD设计5道面试题：
职位：Python后端工程师
要求：
  - 精通Python基础
  - 熟悉Django/Flask框架
  - 了解数据库设计
  - 有高并发经验加分

请：
1. 从简单到困难排序题目
2. 包含参考答案
3. 评估每个问题的难度（1-5星）
"""

# 代码审查
review_prompt = """
你是一位资深的代码审查工程师，负责团队代码质量。

请审查以下Python代码，从以下角度给出反馈：
1. 代码风格
2. 潜在bug
3. 性能问题
4. 可读性
5. 改进建议

【代码】
"""
```

---

## 3.4 高级技巧

### 3.4.1 技巧1：思维树（Tree of Thoughts）

让AI探索多个可能的解决方案，然后选择最优的。

```python
prompt = """
问题：如何用Python实现一个高效的缓存系统？

请按以下步骤思考：

步骤1：列出3-5种可能的实现方案
步骤2：分析每种方案的优缺点
步骤3：评估每种方案的适用场景
步骤4：给出最优方案及完整代码

请详细展开每个步骤。
"""
```

### 3.4.2 技巧2：逆向提示（Reverse Prompting）

先让AI生成答案，再反推问题或改进。

```python
# 逆向生成问题
prompt = """
给定以下Python代码：

```python
def memoize(func):
    cache = {}
    def wrapper(*args):
        if args not in cache:
            cache[args] = func(*args)
        return cache[args]
    return wrapper
```

请：
1. 解释这段代码的作用
2. 构造3个合适的使用场景
3. 为每个场景提供示例代码
4. 总结这个函数的优缺点
"""
```

### 3.4.3 技巧3：渐进式提示（Progressive Prompting）

从简单到复杂，逐步引导AI。

```python
# Level 1: 基础概念
level1 = "什么是Python装饰器？"

# Level 2: 简单应用
level2 = """
现在我理解了装饰器的基本概念。
请提供一个简单的装饰器示例，用于计时函数执行时间。
"""

# Level 3: 复杂应用
level3 = """
很好！现在我需要：
1. 一个可以接受参数的装饰器
2. 用于重试函数执行
3. 支持自定义重试次数和延时
请给出完整实现。
"""

# Level 4: 实战优化
level4 = """
我现在有这个重试装饰器。
请帮我：
1. 添加指数退避策略
2. 记录每次重试的日志
3. 处理特定异常类型
4. 提供使用示例
"""
```

### 3.4.4 技巧4：比较式提示（Comparative Prompting）

让AI对比不同方案。

```python
prompt = """
请对比以下三种Python异步编程方式：

1. asyncio + async/await
2. concurrent.futures
3. multiprocessing

从以下维度对比：
- 使用难度（1-5分）
- 性能表现
- 内存占用
- 适用场景
- 代码示例

请使用表格形式呈现对比结果。
"""
```

### 3.4.5 技巧5：反思与改进（Reflection and Improvement）

```python
prompt = """
【任务】
请设计一个Python类的学生成绩管理系统。

【要求】
1. 支持添加、删除、查询学生
2. 支持成绩统计（平均分、最高分等）
3. 支持成绩排序
4. 代码要清晰易读

【重要】
在提供代码后，请：
1. 自我审查代码的不足之处
2. 指出可能的bug
3. 提供改进版本
4. 总结关键改进点
"""
```

---

## 3.5 不同场景的Prompt模板

### 3.5.1 代码生成

```python
code_gen_prompt = """
# 角色设定
你是一位{language}编程专家，拥有10年开发经验。

# 任务
{task_description}

# 技术要求
- 语言：{language}
- 框架：{framework}（可选）
- 风格：遵循PEP8规范
- 错误处理：包含异常处理

# 代码要求
1. 添加详细注释
2. 包含使用示例
3. 说明时间/空间复杂度
4. 提供测试用例

# 约束条件
{constraints}

# 输出格式
```python
# [功能说明]
def function_name():
    # [代码实现]
    pass

# [使用示例]
# example...

# [复杂度分析]
# Time: O(n)
# Space: O(1)
```
"""
```

### 3.5.2 代码审查

```python
code_review_prompt = """
# 角色设定
你是一位资深代码审查专家，专注于Python代码质量。

# 审查维度
1. **代码风格**
   - 命名规范
   - 代码格式
   - 注释质量

2. **潜在问题**
   - Bug风险
   - 边界情况
   - 错误处理

3. **性能分析**
   - 时间复杂度
   - 空间复杂度
   - 优化空间

4. **最佳实践**
   - 设计模式
   - Pythonic写法
   - 可维护性

# 待审查代码
```python
{code}
```

# 输出格式
## 总体评价
[评分：1-5星] [一句话总结]

## 详细反馈
### ✅ 做得好的地方
- ...

### ⚠️ 需要改进的地方
#### 问题1：[问题描述]
- 位置：第X行
- 问题：...
- 建议：...

### 💡 优化建议
- ...

## 改进后的代码
```python
...
```
"""
```

### 3.5.3 文档生成

```python
doc_gen_prompt = """
# 任务
为以下代码生成完整的文档字符串（Docstring）

# 代码
```python
{code}
```

# 文档要求
遵循Google Python Style Guide，包含：
1. 简要说明（一行）
2. 详细说明（多行）
3. 参数说明（Args）
4. 返回值说明（Returns）
5. 异常说明（Raises）
6. 使用示例（Examples）

# 输出格式
```python
def function_name(param1, param2):
    \"\"\"
    [简要说明]

    [详细说明]

    Args:
        param1 (type): [说明]
        param2 (type): [说明]

    Returns:
        type: [说明]

    Raises:
        Exception: [说明]

    Examples:
        >>> function_name(...)
        [结果]
    \"\"\"
    pass
```
"""
```

### 3.5.4 调试助手

```python
debug_prompt = """
# 角色
你是Python调试专家，擅长快速定位和解决代码问题。

# 问题描述
{error_message}

# 相关代码
```python
{code}
```

# 期望行为
{expected_behavior}

# 实际行为
{actual_behavior}

# 请按以下步骤调试
1. 问题诊断
   - 分析错误信息
   - 定位问题根源
   - 解释为什么会出错

2. 解决方案
   - 提供修复后的代码
   - 说明修复原理

3. 预防措施
   - 如何避免此类问题
   - 最佳实践建议

4. 学习要点
   - 涉及的Python知识点
   - 推荐的学习资源
"""
```

### 3.5.5 教学讲解

```python
teaching_prompt = """
# 角色
你是一位经验丰富的编程导师，擅长用通俗易懂的方式讲解技术概念。

# 教学对象
- 目标：{target_audience}  # 初学者/中级/高级
- 背景：{background}        # 已掌握的技能
- 目标：{learning_goal}     # 想要达成的目标

# 教学主题
{topic}

# 教学要求
1. **循序渐进**
   - 从简单到复杂
   - 用生活化的比喻
   - 避免一开始就讲太多术语

2. **实例驱动**
   - 每个概念配合示例
   - 代码要简洁明了
   - 添加详细注释

3. **互动思考**
   - 提出启发式问题
   - 鼓励动手尝试
   - 提供练习题

4. **总结提升**
   - 关键要点总结
   - 常见误区提示
   - 进阶学习建议

# 输出结构
## 📖 课前知识准备
...

## 💡 核心概念讲解
### 概念1：...
- **是什么**：...
- **为什么需要**：...
- **怎么用**：...
- **代码示例**：...

## 🎯 实战案例
...

## 🤔 思考与练习
...

## 📝 总结与建议
...
"""
```

---

## 3.6 Prompt优化实战案例

### 3.6.1 案例1：从差Prompt到好Prompt

**原始Prompt（差）**：
```python
prompt = "写个爬虫"
```

**第一次优化（中等）**：
```python
prompt = """
用Python写一个爬虫，爬取豆瓣电影Top250的信息。
"""
```

**第二次优化（良好）**：
```python
prompt = """
请用Python编写一个豆瓣电影Top250的爬虫程序。

需要提取：
- 电影名称
- 评分
- 导演
- 主演
- 一句话简介

使用requests和BeautifulSoup库。
"""
```

**最终优化（优秀）**：
```python
prompt = """
# 任务
编写一个Python爬虫，爬取豆瓣电影Top250页面的电影信息

# 目标网站
https://movie.douban.com/top250

# 需要提取的数据
1. 电影名称
2. 评分（float类型）
3. 导演
4. 主演
5. 一句话简介

# 技术要求
- 使用requests库发送请求
- 使用BeautifulSoup解析HTML
- 添加随机的User-Agent
- 请求间隔2-5秒（随机）
- 数据保存为CSV文件

# 代码要求
1. 添加详细注释
2. 使用函数封装
3. 包含异常处理
4. 提供使用示例
5. 说明反爬策略

# 输出格式
```python
# 豆瓣电影Top250爬虫
import ...

def get_movie_info(url):
    \"\"\"
    获取单页电影信息

    Args:
        url: 页面URL

    Returns:
        list: 电影信息列表
    \"\"\"
    # 代码实现
    ...

# 使用示例
if __name__ == "__main__":
    ...
```
"""
```

### 3.6.2 案例2：复杂任务分解

**任务**：构建一个智能代码审查系统

```python
# Step 1: 代码风格检查
style_check_prompt = """
检查以下Python代码的风格问题：
- 命名规范
- 缩进格式
- 行长度
- 导入顺序

【代码】
"""

# Step 2: 潜在Bug识别
bug_detection_prompt = """
分析以下代码可能存在的Bug：
- 边界条件
- 异常处理
- 资源泄漏
- 并发问题

【代码】
"""

# Step 3: 性能分析
performance_prompt = """
分析以下代码的性能问题：
- 时间复杂度
- 空间复杂度
- 优化建议

【代码】
"""

# Step 4: 综合报告
final_report_prompt = """
根据以上分析结果，生成一份完整的代码审查报告。

审查结果：
【风格检查结果】
【Bug检测结果】
【性能分析结果】

请生成：
1. 总体评分（1-10分）
2. 主要问题列表（按优先级排序）
3. 每个问题的详细说明和修复建议
4. 改进后的完整代码
"""
```

---

## 3.7 Prompt测试与迭代

### 3.7.1 A/B测试

```python
# 测试两个不同的Prompt
prompts = {
    "A": "解释什么是Python装饰器",
    "B": """
    你是Python专家。请用以下结构解释装饰器：
    1. 比喻：用生活中的例子类比
    2. 定义：技术层面的解释
    3. 示例：简单代码示例
    4. 应用：3个实际使用场景
    """
}

# 评估维度：
# - 准确性
# - 可读性
# - 完整性
# - 实用性
```

### 3.7.2 Prompt版本管理

```python
# 使用字典管理不同版本
PROMPT_VERSIONS = {
    "v1.0": {
        "prompt": "写个爬虫",
        "score": 3,
        "issues": ["不具体", "缺少约束"]
    },
    "v2.0": {
        "prompt": "用Python写豆瓣爬虫",
        "score": 5,
        "issues": ["缺少具体要求"]
    },
    "v3.0": {
        "prompt": "...",  # 完整版本
        "score": 9,
        "issues": []
    }
}

# 使用最佳版本
best_prompt = PROMPT_VERSIONS["v3.0"]["prompt"]
```

---

## 3.8 本章小结

### 3.8.1 核心要点

✅ **五大核心原则**：
1. 清晰具体（Be Specific）
2. 提供上下文（Provide Context）
3. 明确输出格式（Specify Format）
4. 使用示例（Use Examples）
5. 设定角色（Assign Role）

✅ **常用模式**：
- Chain of Thought（思维链）
- Few-shot Learning（少样本学习）
- Self-Consistency（自洽性）
- Generate Then Refine（先生成后优化）
- Role Playing（角色扮演）

✅ **高级技巧**：
- Tree of Thoughts（思维树）
- Reverse Prompting（逆向提示）
- Progressive Prompting（渐进式提示）
- Comparative Prompting（比较式提示）

### 3.8.2 实践建议

1. **从简单开始**：先构建基础Prompt，再逐步优化
2. **持续迭代**：通过测试不断改进Prompt
3. **建立模板库**：积累常用场景的Prompt模板
4. **A/B测试**：对比不同Prompt的效果
5. **版本管理**：记录Prompt的演进过程

---

## 3.9 练习题

### 练习1：优化Prompt

将以下差Prompt优化为优秀Prompt：

```python
bad_prompt = "写个排序算法"
```

### 练习2：Few-shot Learning

创建一个情感分类的Few-shot Prompt，至少包含3个示例。

### 练习3：角色扮演

设计一个"产品经理"角色的Prompt，用于生成产品需求文档。

### 练习4：思维链

使用CoT技巧，让AI解决一个复杂的数学问题。

### 挑战：构建Prompt模板系统

创建一个Prompt模板管理器，支持：
- 多场景模板
- 参数化输入
- 版本控制
- 效果评估

---

**下一章：[RAG检索增强生成 →](chapter-04)**
