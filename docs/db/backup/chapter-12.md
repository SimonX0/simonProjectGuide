---
title: ç¬¬13ç« ï¼šå®æˆ˜é¡¹ç›®2 - ç”µå•†æ•°æ®åº“è®¾è®¡
---

# ï¼šå®æˆ˜é¡¹ç›®2 - ç”µå•†æ•°æ®åº“è®¾è®¡

> **éš¾åº¦ç­‰çº§**ï¼šâ­â­â­â­ é«˜çº§ | **å­¦ä¹ æ—¶é•¿**ï¼š16å°æ—¶ | **å®æˆ˜é¡¹ç›®**ï¼šå®Œæ•´ç”µå•†ç³»ç»Ÿæ•°æ®åº“è®¾è®¡

## ğŸ“š æœ¬ç« ç›®å½•

- [12.1 é¡¹ç›®éœ€æ±‚åˆ†æ](#121-é¡¹ç›®éœ€æ±‚åˆ†æ)
- [12.2 æ•°æ®åº“è®¾è®¡](#122-æ•°æ®åº“è®¾è®¡)
- [12.3 æ ¸å¿ƒè¡¨ç»“æ„](#123-æ ¸å¿ƒè¡¨ç»“æ„)
- [12.4 äº‹åŠ¡å¤„ç†](#124-äº‹åŠ¡å¤„ç†)
- [12.5 ç¼“å­˜è®¾è®¡](#125-ç¼“å­˜è®¾è®¡)
- [12.6 è¯»å†™åˆ†ç¦»å®ç°](#126-è¯»å†™åˆ†ç¦»å®ç°)
- [12.7 æ€§èƒ½ä¼˜åŒ–](#127-æ€§èƒ½ä¼˜åŒ–)
- [12.8 é¡¹ç›®éƒ¨ç½²](#128-é¡¹ç›®éƒ¨ç½²)

---

## é¡¹ç›®éœ€æ±‚åˆ†æ

### ä¸šåŠ¡èƒŒæ™¯

è®¾è®¡ä¸€ä¸ª**ä¸­å‹ç”µå•†å¹³å°**çš„æ•°æ®åº“ç³»ç»Ÿï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š

```
æ ¸å¿ƒåŠŸèƒ½ï¼š
  1. ç”¨æˆ·ç®¡ç†
     â”œâ”€ æ³¨å†Œ/ç™»å½•
     â”œâ”€ ä¸ªäººä¿¡æ¯
     â””â”€ æ”¶è´§åœ°å€

  2. å•†å“ç®¡ç†
     â”œâ”€ å•†å“åˆ†ç±»
     â”œâ”€ å•†å“ä¿¡æ¯ï¼ˆSKU/SPUï¼‰
     â”œâ”€ åº“å­˜ç®¡ç†
     â””â”€ ä»·æ ¼ç®¡ç†

  3. è®¢å•ç®¡ç†
     â”œâ”€ ä¸‹å•æµç¨‹
     â”œâ”€ è®¢å•æ”¯ä»˜
     â”œâ”€ è®¢å•çŠ¶æ€æµè½¬
     â””â”€ è®¢å•æŸ¥è¯¢

  4. è´­ç‰©è½¦
     â”œâ”€ æ·»åŠ å•†å“
     â”œâ”€ ä¿®æ”¹æ•°é‡
     â””â”€ è´­ç‰©è½¦ç»“ç®—

  5. è¥é”€ç³»ç»Ÿ
     â”œâ”€ ä¼˜æƒ åˆ¸
     â”œâ”€ æ»¡å‡æ´»åŠ¨
     â””â”€ ç§’æ€æ´»åŠ¨

  6. æ•°æ®ç»Ÿè®¡
     â”œâ”€ é”€å”®ç»Ÿè®¡
     â”œâ”€ ç”¨æˆ·è¡Œä¸ºåˆ†æ
     â””â”€ æŠ¥è¡¨æŸ¥è¯¢
```

### éåŠŸèƒ½éœ€æ±‚

| éœ€æ±‚ | è¯´æ˜ | æŒ‡æ ‡ |
|-----|------|-----|
| **å¹¶å‘é‡** | æ”¯æŒ10000+ TPS | å³°å€¼10ä¸‡ |
| **æ•°æ®é‡** | å•†å“1000ä¸‡+ï¼Œè®¢å•1äº¿+ | å¹´å¢50% |
| **å¯ç”¨æ€§** | 99.99% | å¹´åœæœº<1å°æ—¶ |
| **å»¶è¿Ÿ** | æŸ¥è¯¢<100msï¼Œä¸‹å•<500ms | P99 |
| **ä¸€è‡´æ€§** | åº“å­˜ä¸è¶…å–ã€é‡‘é¢ä¸ä¸¢å¤± | å¼ºä¸€è‡´ |

### æŠ€æœ¯æ ˆé€‰æ‹©

```
æ•°æ®åº“é€‰å‹ï¼š
  ä¸»æ•°æ®åº“ï¼šMySQL 8.0
    - æˆç†Ÿç¨³å®šã€ç”Ÿæ€å®Œå–„
    - æ”¯æŒäº‹åŠ¡ã€é€‚åˆç”µå•†åœºæ™¯

  ä»æ•°æ®åº“ï¼šMySQL 8.0ï¼ˆå¤šä¸ªï¼‰
    - è¯»å†™åˆ†ç¦»
    - è´Ÿè½½å‡è¡¡

  ç¼“å­˜ï¼šRedis 7.x
    - çƒ­ç‚¹æ•°æ®ç¼“å­˜
    - åˆ†å¸ƒå¼é”
    - è®¡æ•°å™¨

  æœç´¢ï¼šElasticsearch
    - å•†å“æœç´¢
    - æ—¥å¿—åˆ†æ

  æ¶ˆæ¯é˜Ÿåˆ—ï¼šRabbitMQ
    - å¼‚æ­¥å¤„ç†
    - å‰Šå³°å¡«è°·
```

---

## æ•°æ®åº“è®¾è®¡

### ER å›¾

```mermaid
erDiagram
    USERS ||--o{ ORDERS : "places"
    USERS ||--o{ ADDRESSES : "has"
    USERS ||--o{ CARTS : "adds to"

    PRODUCTS ||--o{ SKU : "has"
    PRODUCTS ||--o{ PRODUCT_CATEGORIES : "belongs to"
    PRODUCTS ||--o{ ORDERS : "ordered in"

    SKU ||--o{ CART_ITEMS : "included in"
    SKU ||--o{ ORDER_ITEMS : "included in"
    SKU ||--o{ INVENTORY : "tracks"

    ORDERS ||--o{ ORDER_ITEMS : "contains"
    ORDERS ||--o{ PAYMENTS : "paid by"

    ADDRESSES ||--o{ ORDERS : "delivered to"

    USERS {
        bigint id PK
        string username
        string email
        string password
        datetime created_at
    }

    PRODUCTS {
        bigint id PK
        string name
        string description
        bigint category_id FK
        datetime created_at
    }

    SKU {
        bigint id PK
        bigint product_id FK
        string spec
        decimal price
        int stock
    }

    ORDERS {
        bigint id PK
        bigint user_id FK
        string order_no
        decimal total_amount
        string status
        datetime created_at
    }

    ORDER_ITEMS {
        bigint id PK
        bigint order_id FK
        bigint sku_id FK
        int quantity
        decimal price
    }

    INVENTORY {
        bigint sku_id PK
        int available_stock
        int frozen_stock
        datetime updated_at
    }
```

### åˆ†åº“åˆ†è¡¨è®¾è®¡

```
æ•°æ®åº“åˆ†åº“ï¼š
  user_db      - ç”¨æˆ·ç›¸å…³è¡¨
  product_db   - å•†å“ç›¸å…³è¡¨
  order_db     - è®¢å•ç›¸å…³è¡¨
  payment_db   - æ”¯ä»˜ç›¸å…³è¡¨
  marketing_db - è¥é”€ç›¸å…³è¡¨

è¡¨åˆ†è¡¨ç­–ç•¥ï¼š
  1. æ°´å¹³åˆ†è¡¨ï¼ˆè®¢å•è¡¨ï¼‰
     - æŒ‰ user_id å–æ¨¡åˆ†è¡¨
     - order_0, order_1, ..., order_15ï¼ˆ16å¼ è¡¨ï¼‰
     - è·¯ç”±ï¼štable = order_{user_id % 16}

  2. æ—¶é—´åˆ†åŒºï¼ˆè®¢å•è¡¨ï¼‰
     - æŒ‰åˆ›å»ºæ—¶é—´åˆ†åŒº
     - æŒ‰æœˆåˆ†åŒºï¼šorders_202401, orders_202402, ...
     - å½’æ¡£ç­–ç•¥ï¼š6ä¸ªæœˆå‰æ•°æ®å½’æ¡£

  3. å‚ç›´åˆ†è¡¨ï¼ˆå•†å“è¡¨ï¼‰
     - å•†å“åŸºç¡€è¡¨ï¼šproducts
     - å•†å“è¯¦æƒ…è¡¨ï¼šproduct_details
     - å•†å“æ‰©å±•è¡¨ï¼šproduct_ext
```

---

## æ ¸å¿ƒè¡¨ç»“æ„

### ç”¨æˆ·æ¨¡å—

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·å',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç ï¼ˆbcryptï¼‰',
    email VARCHAR(100) NOT NULL COMMENT 'é‚®ç®±',
    mobile VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    nickname VARCHAR(50) COMMENT 'æ˜µç§°',
    avatar VARCHAR(500) COMMENT 'å¤´åƒURL',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1æ­£å¸¸ï¼Œ0ç¦ç”¨',
    register_ip VARCHAR(50) COMMENT 'æ³¨å†ŒIP',
    last_login_at TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
    last_login_ip VARCHAR(50) COMMENT 'æœ€åç™»å½•IP',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    UNIQUE KEY uk_username (username),
    UNIQUE KEY uk_email (email),
    UNIQUE KEY uk_mobile (mobile),
    KEY idx_status (status),
    KEY idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';

-- æ”¶è´§åœ°å€è¡¨
CREATE TABLE user_addresses (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'åœ°å€ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
    consignee VARCHAR(50) NOT NULL COMMENT 'æ”¶è´§äºº',
    mobile VARCHAR(20) NOT NULL COMMENT 'æ‰‹æœºå·',
    province VARCHAR(50) NOT NULL COMMENT 'çœ',
    city VARCHAR(50) NOT NULL COMMENT 'å¸‚',
    district VARCHAR(50) NOT NULL COMMENT 'åŒº',
    detail_address VARCHAR(200) NOT NULL COMMENT 'è¯¦ç»†åœ°å€',
    postal_code VARCHAR(10) COMMENT 'é‚®ç¼–',
    is_default TINYINT NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦é»˜è®¤ï¼š1æ˜¯ï¼Œ0å¦',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    KEY idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ”¶è´§åœ°å€è¡¨';
```

### å•†å“æ¨¡å—

```sql
-- å•†å“åˆ†ç±»è¡¨
CREATE TABLE categories (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'åˆ†ç±»ID',
    parent_id BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'çˆ¶åˆ†ç±»ID',
    name VARCHAR(100) NOT NULL COMMENT 'åˆ†ç±»åç§°',
    icon VARCHAR(500) COMMENT 'å›¾æ ‡URL',
    level TINYINT NOT NULL COMMENT 'å±‚çº§ï¼š1ä¸€çº§ï¼Œ2äºŒçº§ï¼Œ3ä¸‰çº§',
    sort_order INT NOT NULL DEFAULT 0 COMMENT 'æ’åº',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1å¯ç”¨ï¼Œ0ç¦ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    KEY idx_parent_id (parent_id),
    KEY idx_level (level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å•†å“åˆ†ç±»è¡¨';

-- å•†å“SPUè¡¨ï¼ˆæ ‡å‡†åŒ–äº§å“ï¼‰
CREATE TABLE products (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'å•†å“ID',
    category_id BIGINT UNSIGNED NOT NULL COMMENT 'åˆ†ç±»ID',
    brand_id BIGINT UNSIGNED COMMENT 'å“ç‰ŒID',
    name VARCHAR(200) NOT NULL COMMENT 'å•†å“åç§°',
    sub_title VARCHAR(200) COMMENT 'å‰¯æ ‡é¢˜',
    description TEXT COMMENT 'å•†å“æè¿°',
    detail HTML TEXT COMMENT 'å•†å“è¯¦æƒ…ï¼ˆå¯Œæ–‡æœ¬ï¼‰',
    main_image VARCHAR(500) COMMENT 'ä¸»å›¾',
    images JSON COMMENT 'å›¾ç‰‡åˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰',
    video VARCHAR(500) COMMENT 'è§†é¢‘URL',
    unit VARCHAR(20) COMMENT 'å•ä½ï¼ˆä»¶ã€ç›’ã€ç®±ï¼‰',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1ä¸Šæ¶ï¼Œ0ä¸‹æ¶',
    sort_order INT NOT NULL DEFAULT 0 COMMENT 'æ’åº',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    KEY idx_category_id (category_id),
    KEY idx_brand_id (brand_id),
    KEY idx_status (status),
    FULLTEXT KEY ft_name_description (name, description) WITH PARSER ngram
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å•†å“SPUè¡¨';

-- å•†å“SKUè¡¨ï¼ˆåº“å­˜å•ä½ï¼‰
CREATE TABLE skus (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'SKU ID',
    product_id BIGINT UNSIGNED NOT NULL COMMENT 'å•†å“ID',
    sku_code VARCHAR(50) NOT NULL COMMENT 'SKUç¼–ç ',
    spec JSON COMMENT 'è§„æ ¼ï¼ˆJSONï¼š{"é¢œè‰²":"çº¢è‰²","å°ºå¯¸":"XL"}ï¼‰',
    price DECIMAL(10,2) NOT NULL COMMENT 'é”€å”®ä»·',
    original_price DECIMAL(10,2) COMMENT 'åŸä»·',
    cost_price DECIMAL(10,2) COMMENT 'æˆæœ¬ä»·',
    stock INT NOT NULL DEFAULT 0 COMMENT 'åº“å­˜',
    sales INT NOT NULL DEFAULT 0 COMMENT 'é”€é‡',
    image VARCHAR(500) COMMENT 'SKUå›¾ç‰‡',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1ä¸Šæ¶ï¼Œ0ä¸‹æ¶',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    UNIQUE KEY uk_sku_code (sku_code),
    KEY idx_product_id (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å•†å“SKUè¡¨';

-- åº“å­˜è¡¨ï¼ˆç‹¬ç«‹ç®¡ç†ï¼‰
CREATE TABLE inventory (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
    sku_id BIGINT UNSIGNED NOT NULL COMMENT 'SKU ID',
    warehouse_id BIGINT UNSIGNED NOT NULL COMMENT 'ä»“åº“ID',
    available_stock INT NOT NULL DEFAULT 0 COMMENT 'å¯ç”¨åº“å­˜',
    frozen_stock INT NOT NULL DEFAULT 0 COMMENT 'å†»ç»“åº“å­˜',
    total_stock INT NOT NULL DEFAULT 0 COMMENT 'æ€»åº“å­˜',
    version INT NOT NULL DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    UNIQUE KEY uk_sku_warehouse (sku_id, warehouse_id),
    KEY idx_warehouse_id (warehouse_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åº“å­˜è¡¨';
```

### è®¢å•æ¨¡å—

```sql
-- è®¢å•è¡¨ï¼ˆåˆ†è¡¨ï¼‰
CREATE TABLE orders_0 (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'è®¢å•ID',
    order_no VARCHAR(50) NOT NULL COMMENT 'è®¢å•å·',
    user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
    total_amount DECIMAL(10,2) NOT NULL COMMENT 'è®¢å•æ€»é‡‘é¢',
    discount_amount DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT 'ä¼˜æƒ é‡‘é¢',
    freight_amount DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT 'è¿è´¹',
    payable_amount DECIMAL(10,2) NOT NULL COMMENT 'åº”ä»˜é‡‘é¢',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1å¾…æ”¯ä»˜ï¼Œ2å¾…å‘è´§ï¼Œ3å¾…æ”¶è´§ï¼Œ4å·²å®Œæˆï¼Œ5å·²å–æ¶ˆ',
    payment_status TINYINT NOT NULL DEFAULT 0 COMMENT 'æ”¯ä»˜çŠ¶æ€ï¼š0æœªæ”¯ä»˜ï¼Œ1å·²æ”¯ä»˜',
    payment_time TIMESTAMP NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
    shipment_time TIMESTAMP NULL COMMENT 'å‘è´§æ—¶é—´',
    receipt_time TIMESTAMP NULL COMMENT 'æ”¶è´§æ—¶é—´',

    -- æ”¶è´§ä¿¡æ¯ï¼ˆå†—ä½™ï¼Œé¿å…å…³è”æŸ¥è¯¢ï¼‰
    consignee VARCHAR(50) NOT NULL COMMENT 'æ”¶è´§äºº',
    mobile VARCHAR(20) NOT NULL COMMENT 'æ‰‹æœºå·',
    province VARCHAR(50) NOT NULL COMMENT 'çœ',
    city VARCHAR(50) NOT NULL COMMENT 'å¸‚',
    district VARCHAR(50) NOT NULL COMMENT 'åŒº',
    detail_address VARCHAR(200) NOT NULL COMMENT 'è¯¦ç»†åœ°å€',

    -- å¤‡æ³¨
    user_remark VARCHAR(500) COMMENT 'ç”¨æˆ·å¤‡æ³¨',
    admin_remark VARCHAR(500) COMMENT 'ç®¡ç†å‘˜å¤‡æ³¨',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    UNIQUE KEY uk_order_no (order_no),
    KEY idx_user_id (user_id),
    KEY idx_status (status),
    KEY idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•è¡¨';

-- è®¢å•å•†å“æ˜ç»†è¡¨
CREATE TABLE order_items_0 (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'æ˜ç»†ID',
    order_id BIGINT UNSIGNED NOT NULL COMMENT 'è®¢å•ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
    product_id BIGINT UNSIGNED NOT NULL COMMENT 'å•†å“ID',
    sku_id BIGINT UNSIGNED NOT NULL COMMENT 'SKU ID',
    sku_name VARCHAR(200) NOT NULL COMMENT 'SKUåç§°ï¼ˆå†—ä½™ï¼‰',
    sku_spec JSON COMMENT 'SKUè§„æ ¼ï¼ˆå†—ä½™ï¼‰',
    sku_image VARCHAR(500) COMMENT 'SKUå›¾ç‰‡ï¼ˆå†—ä½™ï¼‰',
    price DECIMAL(10,2) NOT NULL COMMENT 'å•ä»·',
    quantity INT NOT NULL COMMENT 'æ•°é‡',
    total_amount DECIMAL(10,2) NOT NULL COMMENT 'å°è®¡é‡‘é¢',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',

    PRIMARY KEY (id),
    KEY idx_order_id (order_id),
    KEY idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¢å•å•†å“æ˜ç»†è¡¨';

-- è´­ç‰©è½¦è¡¨
CREATE TABLE cart_items (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
    sku_id BIGINT UNSIGNED NOT NULL COMMENT 'SKU ID',
    quantity INT NOT NULL COMMENT 'æ•°é‡',
    is_checked TINYINT NOT NULL DEFAULT 1 COMMENT 'æ˜¯å¦é€‰ä¸­ï¼š1æ˜¯ï¼Œ0å¦',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    UNIQUE KEY uk_user_sku (user_id, sku_id),
    KEY idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è´­ç‰©è½¦è¡¨';
```

### è¥é”€æ¨¡å—

```sql
-- ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE coupons (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ä¼˜æƒ åˆ¸ID',
    name VARCHAR(100) NOT NULL COMMENT 'ä¼˜æƒ åˆ¸åç§°',
    type TINYINT NOT NULL COMMENT 'ç±»å‹ï¼š1æ»¡å‡åˆ¸ï¼Œ2æŠ˜æ‰£åˆ¸ï¼Œ3æ— é—¨æ§›åˆ¸',
    discount_type TINYINT NOT NULL COMMENT 'ä¼˜æƒ ç±»å‹ï¼š1é‡‘é¢ï¼Œ2æŠ˜æ‰£',
    discount_value DECIMAL(10,2) NOT NULL COMMENT 'ä¼˜æƒ å€¼',
    min_amount DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT 'æœ€å°ä½¿ç”¨é‡‘é¢',
    max_discount DECIMAL(10,2) COMMENT 'æœ€å¤§ä¼˜æƒ é‡‘é¢',
    total_count INT NOT NULL COMMENT 'å‘è¡Œæ€»é‡',
    received_count INT NOT NULL DEFAULT 0 COMMENT 'å·²é¢†å–æ•°é‡',
    used_count INT NOT NULL DEFAULT 0 COMMENT 'å·²ä½¿ç”¨æ•°é‡',
    per_user_limit INT NOT NULL DEFAULT 1 COMMENT 'æ¯äººé™é¢†',
    valid_days INT NOT NULL COMMENT 'æœ‰æ•ˆå¤©æ•°',
    start_time TIMESTAMP NULL COMMENT 'å¼€å§‹æ—¶é—´',
    end_time TIMESTAMP NULL COMMENT 'ç»“æŸæ—¶é—´',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1å¯ç”¨ï¼Œ0ç¦ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    KEY idx_type (type),
    KEY idx_status (status),
    KEY idx_time (start_time, end_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä¼˜æƒ åˆ¸è¡¨';

-- ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE user_coupons (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
    coupon_id BIGINT UNSIGNED NOT NULL COMMENT 'ä¼˜æƒ åˆ¸ID',
    coupon_name VARCHAR(100) NOT NULL COMMENT 'ä¼˜æƒ åˆ¸åç§°ï¼ˆå†—ä½™ï¼‰',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1æœªä½¿ç”¨ï¼Œ2å·²ä½¿ç”¨ï¼Œ3å·²è¿‡æœŸ',
    order_id BIGINT UNSIGNED COMMENT 'ä½¿ç”¨è®¢å•ID',
    receive_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'é¢†å–æ—¶é—´',
    use_time TIMESTAMP NULL COMMENT 'ä½¿ç”¨æ—¶é—´',
    expire_time TIMESTAMP NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',

    PRIMARY KEY (id),
    KEY idx_user_id (user_id),
    KEY idx_coupon_id (coupon_id),
    KEY idx_status (status),
    KEY idx_expire_time (expire_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨';

-- ç§’æ€æ´»åŠ¨è¡¨
CREATE TABLE seckill_activities (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'æ´»åŠ¨ID',
    name VARCHAR(100) NOT NULL COMMENT 'æ´»åŠ¨åç§°',
    sku_id BIGINT UNSIGNED NOT NULL COMMENT 'SKU ID',
    seckill_price DECIMAL(10,2) NOT NULL COMMENT 'ç§’æ€ä»·',
    stock INT NOT NULL COMMENT 'ç§’æ€åº“å­˜',
    limit_per_user INT NOT NULL DEFAULT 1 COMMENT 'æ¯äººé™è´­',
    start_time TIMESTAMP NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
    end_time TIMESTAMP NOT NULL COMMENT 'ç»“æŸæ—¶é—´',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1æœªå¼€å§‹ï¼Œ2è¿›è¡Œä¸­ï¼Œ3å·²ç»“æŸ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',

    PRIMARY KEY (id),
    KEY idx_sku_id (sku_id),
    KEY idx_time (start_time, end_time),
    KEY idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç§’æ€æ´»åŠ¨è¡¨';
```

---

## äº‹åŠ¡å¤„ç†

### ä¸‹å•äº‹åŠ¡

```python
import mysql.connector
from mysql.connector import pooling
from redis import Redis

class OrderService:
    def __init__(self):
        # è¿æ¥æ± 
        self.db_pool = pooling.MySQLConnectionPool(
            pool_name="order_pool",
            pool_size=20,
            host="192.168.1.10",
            port=3306,
            user="root",
            password="Root@2024",
            database="order_db"
        )

        # Redis
        self.redis = Redis(host="192.168.1.20", port=6379, decode_responses=True)

    def create_order(self, user_id, address_id, cart_items, coupon_id=None):
        """åˆ›å»ºè®¢å•"""
        conn = self.db_pool.get_connection()

        try:
            # å¼€å§‹äº‹åŠ¡
            conn.start_transaction()

            cursor = conn.cursor(dictionary=True)

            # 1. æŸ¥è¯¢æ”¶è´§åœ°å€
            cursor.execute("""
                SELECT * FROM user_addresses
                WHERE id = %s AND user_id = %s
            """, (address_id, user_id))

            address = cursor.fetchone()
            if not address:
                raise Exception("æ”¶è´§åœ°å€ä¸å­˜åœ¨")

            # 2. é”å®šè´­ç‰©è½¦å•†å“ï¼ˆRedis + æ•°æ®åº“ï¼‰
            sku_ids = [item['sku_id'] for item in cart_items]

            # Redis é¢„æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰
            pipe = self.redis.pipeline()
            for item in cart_items:
                key = f"stock:{item['sku_id']}"
                pipe.hget(key, 'available')
                pipe.hget(key, 'frozen')

            results = pipe.execute()

            # æ£€æŸ¥åº“å­˜
            stock_info = {}
            for i, item in enumerate(cart_items):
                sku_id = item['sku_id']
                available = int(results[i*2] or 0)
                frozen = int(results[i*2+1] or 0)
                stock_info[sku_id] = {'available': available, 'frozen': frozen}

                if available < item['quantity']:
                    raise Exception(f"å•†å“ {item['sku_id']} åº“å­˜ä¸è¶³")

            # 3. æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆåŠ é”ï¼‰
            placeholders = ','.join(['%s'] * len(sku_ids))
            cursor.execute(f"""
                SELECT
                    s.id AS sku_id,
                    s.price,
                    s.stock,
                    p.name AS product_name,
                    p.id AS product_id
                FROM skus s
                INNER JOIN products p ON s.product_id = p.id
                WHERE s.id IN ({placeholders})
                FOR UPDATE
            """, sku_ids)

            skus = cursor.fetchall()
            sku_dict = {s['sku_id']: s for s in skus}

            # 4. å†»ç»“åº“å­˜
            for item in cart_items:
                sku_id = item['sku_id']
                quantity = item['quantity']

                cursor.execute("""
                    UPDATE inventory
                    SET available_stock = available_stock - %s,
                        frozen_stock = frozen_stock + %s,
                        version = version + 1
                    WHERE sku_id = %s AND available_stock >= %s
                """, (quantity, quantity, sku_id, quantity))

                if cursor.rowcount == 0:
                    raise Exception(f"å•†å“ {sku_id} åº“å­˜ä¸è¶³")

                # åŒæ­¥åˆ° Redis
                self.redis.hincrby(f"stock:{sku_id}", 'available', -quantity)
                self.redis.hincrby(f"stock:{sku_id}", 'frozen', quantity)

            # 5. è®¡ç®—é‡‘é¢
            total_amount = 0
            order_items = []

            for item in cart_items:
                sku = sku_dict[item['sku_id']]
                subtotal = sku['price'] * item['quantity']
                total_amount += subtotal

                order_items.append({
                    'product_id': sku['product_id'],
                    'sku_id': item['sku_id'],
                    'sku_name': sku['product_name'],
                    'price': sku['price'],
                    'quantity': item['quantity'],
                    'total_amount': subtotal
                })

            discount_amount = 0

            # 6. ä½¿ç”¨ä¼˜æƒ åˆ¸
            if coupon_id:
                # æŸ¥è¯¢ä¼˜æƒ åˆ¸
                cursor.execute("""
                    SELECT * FROM user_coupons
                    WHERE id = %s AND user_id = %s AND status = 1
                    FOR UPDATE
                """, (coupon_id, user_id))

                user_coupon = cursor.fetchone()

                if user_coupon:
                    # æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯
                    cursor.execute("""
                        SELECT * FROM coupons WHERE id = %s
                    """, (user_coupon['coupon_id'],))

                    coupon = cursor.fetchone()

                    # è®¡ç®—ä¼˜æƒ 
                    if coupon['min_amount'] <= total_amount:
                        if coupon['discount_type'] == 1:  # é‡‘é¢
                            discount_amount = coupon['discount_value']
                        elif coupon['discount_type'] == 2:  # æŠ˜æ‰£
                            discount_amount = total_amount * (1 - coupon['discount_value'])

                        # æ ‡è®°ä¼˜æƒ åˆ¸å·²ä½¿ç”¨
                        cursor.execute("""
                            UPDATE user_coupons
                            SET status = 2, order_id = %s, use_time = NOW()
                            WHERE id = %s
                        """, ('ORDER_NO', coupon_id))

                        cursor.execute("""
                            UPDATE coupons
                            SET used_count = used_count + 1
                            WHERE id = %s
                        """, (coupon['id'],))

            freight_amount = 10  # è¿è´¹ï¼ˆç®€åŒ–ï¼‰
            payable_amount = total_amount - discount_amount + freight_amount

            # 7. åˆ›å»ºè®¢å•
            order_no = self._generate_order_no()

            cursor.execute("""
                INSERT INTO orders_0 (
                    order_no, user_id,
                    total_amount, discount_amount, freight_amount, payable_amount,
                    consignee, mobile,
                    province, city, district, detail_address
                ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            """, (
                order_no, user_id,
                total_amount, discount_amount, freight_amount, payable_amount,
                address['consignee'], address['mobile'],
                address['province'], address['city'],
                address['district'], address['detail_address']
            ))

            order_id = cursor.lastrowid

            # 8. åˆ›å»ºè®¢å•æ˜ç»†
            for item in order_items:
                cursor.execute("""
                    INSERT INTO order_items_0 (
                        order_id, user_id, product_id, sku_id,
                        sku_name, price, quantity, total_amount
                    ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                """, (
                    order_id, user_id, item['product_id'], item['sku_id'],
                    item['sku_name'], item['price'], item['quantity'], item['total_amount']
                ))

            # 9. æ¸…ç©ºè´­ç‰©è½¦
            placeholders = ','.join(['%s'] * len(cart_items))
            cursor.execute(f"""
                DELETE FROM cart_items
                WHERE user_id = %s AND sku_id IN ({placeholders})
            """, [user_id] + [item['sku_id'] for item in cart_items])

            # æäº¤äº‹åŠ¡
            conn.commit()

            return {
                'order_id': order_id,
                'order_no': order_no,
                'payable_amount': payable_amount
            }

        except Exception as e:
            # å›æ»šäº‹åŠ¡
            conn.rollback()

            # æ¢å¤ Redis åº“å­˜
            for item in cart_items:
                sku_id = item['sku_id']
                quantity = item['quantity']
                self.redis.hincrby(f"stock:{sku_id}", 'available', quantity)
                self.redis.hincrby(f"stock:{sku_id}", 'frozen', -quantity)

            raise

        finally:
            conn.close()

    def _generate_order_no(self):
        """ç”Ÿæˆè®¢å•å·"""
        import time
        import random

        timestamp = int(time.time() * 1000)
        random_num = random.randint(1000, 9999)
        return f"{timestamp}{random_num}"
```

### æ”¯ä»˜äº‹åŠ¡

```python
class PaymentService:
    def __init__(self):
        self.db_pool = pooling.MySQLConnectionPool(...)
        self.redis = Redis(...)

    def pay_order(self, order_no, payment_method):
        """æ”¯ä»˜è®¢å•"""
        conn = self.db_pool.get_connection()

        try:
            conn.start_transaction()
            cursor = conn.cursor(dictionary=True)

            # 1. æŸ¥è¯¢è®¢å•ï¼ˆåŠ é”ï¼‰
            cursor.execute("""
                SELECT * FROM orders_0
                WHERE order_no = %s
                FOR UPDATE
            """, (order_no,))

            order = cursor.fetchone()

            if not order:
                raise Exception("è®¢å•ä¸å­˜åœ¨")

            if order['status'] != 1:
                raise Exception("è®¢å•çŠ¶æ€å¼‚å¸¸")

            if order['payment_status'] == 1:
                raise Exception("è®¢å•å·²æ”¯ä»˜")

            # 2. æ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆç®€åŒ–ï¼‰
            cursor.execute("""
                UPDATE user_accounts
                SET balance = balance - %s
                WHERE user_id = %s AND balance >= %s
            """, (order['payable_amount'], order['user_id'], order['payable_amount']))

            if cursor.rowcount == 0:
                raise Exception("ä½™é¢ä¸è¶³")

            # 3. æ›´æ–°è®¢å•çŠ¶æ€
            cursor.execute("""
                UPDATE orders_0
                SET status = 2,
                    payment_status = 1,
                    payment_time = NOW()
                WHERE order_no = %s
            """, (order_no,))

            # 4. æ‰£å‡åº“å­˜ï¼ˆå†»ç»“ -> å·²æ‰£ï¼‰
            cursor.execute("""
                SELECT sku_id, quantity
                FROM order_items_0
                WHERE order_id = %s
            """, (order['id'],))

            items = cursor.fetchall()

            for item in items:
                cursor.execute("""
                    UPDATE inventory
                    SET frozen_stock = frozen_stock - %s
                    WHERE sku_id = %s
                """, (item['quantity'], item['sku_id']))

                # åŒæ­¥åˆ° Redis
                self.redis.hincrby(f"stock:{item['sku_id']}", 'frozen', -item['quantity'])

            # 5. åˆ›å»ºæ”¯ä»˜è®°å½•
            cursor.execute("""
                INSERT INTO payments (order_no, user_id, amount, payment_method)
                VALUES (%s, %s, %s, %s)
            """, (order_no, order['user_id'], order['payable_amount'], payment_method))

            # æäº¤äº‹åŠ¡
            conn.commit()

            # 6. å‘é€æ¶ˆæ¯ï¼ˆå¼‚æ­¥ï¼‰
            self._send_payment_message(order)

            return True

        except Exception as e:
            conn.rollback()
            raise

        finally:
            conn.close()

    def _send_payment_message(self, order):
        """å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯"""
        # å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        # ...
        pass
```

---

## ç¼“å­˜è®¾è®¡

### ç¼“å­˜æ¶æ„

```
å¤šçº§ç¼“å­˜ï¼š
  L1: åº”ç”¨æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
      - é…ç½®æ•°æ®
      - çƒ­ç‚¹å•†å“

  L2: Redis åˆ†å¸ƒå¼ç¼“å­˜
      - å•†å“è¯¦æƒ…
      - åº“å­˜æ•°æ®
      - ç”¨æˆ·ä¿¡æ¯
      - è´­ç‰©è½¦

  L3: MySQL æ•°æ®åº“
      - æŒä¹…åŒ–å­˜å‚¨
```

### å•†å“ç¼“å­˜

```python
import json
from redis import Redis

class ProductCache:
    def __init__(self):
        self.redis = Redis(host="localhost", port=6379, decode_responses=True)
        self.cache_expire = 3600  # 1å°æ—¶

    def get_product(self, product_id):
        """è·å–å•†å“ï¼ˆç¼“å­˜ä¼˜å…ˆï¼‰"""
        # 1. æŸ¥è¯¢ç¼“å­˜
        cache_key = f"product:{product_id}"
        cached = self.redis.get(cache_key)

        if cached:
            return json.loads(cached)

        # 2. æŸ¥è¯¢æ•°æ®åº“
        product = self._get_product_from_db(product_id)

        # 3. å†™å…¥ç¼“å­˜
        self.redis.setex(cache_key, self.cache_expire, json.dumps(product))

        return product

    def _get_product_from_db(self, product_id):
        """ä»æ•°æ®åº“æŸ¥è¯¢å•†å“"""
        # å®ç°çœç•¥
        pass

    def update_product(self, product_id, data):
        """æ›´æ–°å•†å“ï¼ˆåŒæ—¶æ›´æ–°ç¼“å­˜ï¼‰"""
        # 1. æ›´æ–°æ•°æ®åº“
        self._update_product_to_db(product_id, data)

        # 2. åˆ é™¤ç¼“å­˜ï¼ˆç­‰å¾…ä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡å»ºï¼‰
        cache_key = f"product:{product_id}"
        self.redis.delete(cache_key)

    def batch_get_products(self, product_ids):
        """æ‰¹é‡è·å–å•†å“"""
        # 1. æ‰¹é‡æŸ¥è¯¢ç¼“å­˜
        cache_keys = [f"product:{pid}" for pid in product_ids]
        cached_values = self.redis.mget(cache_keys)

        # 2. åˆ†ç±»ï¼šç¼“å­˜å‘½ä¸­å’Œæœªå‘½ä¸­
        results = {}
        missing_ids = []

        for i, pid in enumerate(product_ids):
            if cached_values[i]:
                results[pid] = json.loads(cached_values[i])
            else:
                missing_ids.append(pid)

        # 3. æŸ¥è¯¢æœªå‘½ä¸­çš„å•†å“
        if missing_ids:
            db_results = self._batch_get_products_from_db(missing_ids)

            # 4. å†™å…¥ç¼“å­˜
            pipe = self.redis.pipeline()
            for pid, product in db_results.items():
                results[pid] = product
                cache_key = f"product:{pid}"
                pipe.setex(cache_key, self.cache_expire, json.dumps(product))

            pipe.execute()

        return results
```

### åº“å­˜ç¼“å­˜

```python
class StockCache:
    def __init__(self):
        self.redis = Redis(host="localhost", port=6379, decode_responses=True)

    def init_stock(self, sku_id, stock):
        """åˆå§‹åŒ–åº“å­˜åˆ° Redis"""
        key = f"stock:{sku_id}"
        self.redis.hset(key, 'available', stock)
        self.redis.hset(key, 'frozen', 0)

    def get_stock(self, sku_id):
        """è·å–åº“å­˜"""
        key = f"stock:{sku_id}"
        stock_info = self.redis.hgetall(key)

        if not stock_info:
            # ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
            stock_info = self._load_stock_from_db(sku_id)
            self.redis.hset(key, 'available', stock_info['available'])
            self.redis.hset(key, 'frozen', stock_info['frozen'])

        return {
            'available': int(stock_info.get('available', 0)),
            'frozen': int(stock_info.get('frozen', 0))
        }

    def deduct_stock(self, sku_id, quantity):
        """æ‰£å‡åº“å­˜ï¼ˆåŸå­æ“ä½œï¼‰"""
        # Lua è„šæœ¬ä¿è¯åŸå­æ€§
        lua_script = """
        local key = KEYS[1]
        local quantity = tonumber(ARGV[1])

        local available = tonumber(redis.call('HGET', key, 'available'))
        local frozen = tonumber(redis.call('HGET', key, 'frozen'))

        if available >= quantity then
            redis.call('HINCRBY', key, 'available', -quantity)
            redis.call('HINCRBY', key, 'frozen', quantity)
            return 1
        else
            return 0
        end
        """

        result = self.redis.eval(lua_script, 1, f"stock:{sku_id}", quantity)
        return result == 1

    def restore_stock(self, sku_id, quantity):
        """æ¢å¤åº“å­˜"""
        key = f"stock:{sku_id}"
        self.redis.hincrby(key, 'available', quantity)
        self.redis.hincrby(key, 'frozen', -quantity)
```

### ç¼“å­˜æ›´æ–°ç­–ç•¥

```python
# Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰- æ¨è

def get_product(product_id):
    # 1. æŸ¥ç¼“å­˜
    product = redis.get(f"product:{product_id}")
    if product:
        return json.loads(product)

    # 2. æŸ¥æ•°æ®åº“
    product = db.query("SELECT * FROM products WHERE id = %s", product_id)

    # 3. å†™ç¼“å­˜
    redis.setex(f"product:{product_id}", 3600, json.dumps(product))

    return product

def update_product(product_id, data):
    # 1. æ›´æ–°æ•°æ®åº“
    db.execute("UPDATE products SET ... WHERE id = %s", product_id, data)

    # 2. åˆ é™¤ç¼“å­˜ï¼ˆä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼‰
    redis.delete(f"product:{product_id}")
```

---

## è¯»å†™åˆ†ç¦»å®ç°

### æ•°æ®åº“ä¸­é—´ä»¶

```python
import mysql.connector
from mysql.connector import pooling

class ReadWriteSplitRouter:
    def __init__(self, master_config, slave_configs):
        # ä¸»åº“è¿æ¥æ± 
        self.master_pool = pooling.MySQLConnectionPool(
            pool_name="master",
            pool_size=10,
            **master_config
        )

        # ä»åº“è¿æ¥æ± 
        self.slave_pools = []
        for i, config in enumerate(slave_configs):
            pool = pooling.MySQLConnectionPool(
                pool_name=f"slave_{i}",
                pool_size=10,
                **config
            )
            self.slave_pools.append(pool)

    def get_connection(self, read_only=False):
        """è·å–è¿æ¥"""
        if read_only:
            # éšæœºé€‰æ‹©ä»åº“
            import random
            pool = random.choice(self.slave_pools)
            return pool.get_connection()
        else:
            return self.master_pool.get_connection()

    def execute_read(self, query, params=None):
        """æ‰§è¡Œè¯»æ“ä½œ"""
        conn = self.get_connection(read_only=True)
        cursor = conn.cursor(dictionary=True)
        cursor.execute(query, params or ())
        return cursor.fetchall()

    def execute_write(self, query, params=None):
        """æ‰§è¡Œå†™æ“ä½œ"""
        conn = self.get_connection(read_only=False)
        cursor = conn.cursor()
        cursor.execute(query, params or ())
        conn.commit()
        return cursor.lastrowid

# é…ç½®
router = ReadWriteSplitRouter(
    master_config={
        'host': '192.168.1.10',
        'port': 3306,
        'user': 'root',
        'password': 'Root@2024',
        'database': 'order_db'
    },
    slave_configs=[
        {
            'host': '192.168.1.11',
            'port': 3306,
            'user': 'root',
            'password': 'Root@2024',
            'database': 'order_db'
        },
        {
            'host': '192.168.1.12',
            'port': 3306,
            'user': 'root',
            'password': 'Root@2024',
            'database': 'order_db'
        }
    ]
)

# ä½¿ç”¨ç¤ºä¾‹
class OrderService:
    def __init__(self):
        self.router = router

    def get_order(self, order_id):
        """æŸ¥è¯¢è®¢å•ï¼ˆè¯»ä»åº“ï¼‰"""
        return self.router.execute_read(
            "SELECT * FROM orders_0 WHERE id = %s",
            (order_id,)
        )

    def create_order(self, order_data):
        """åˆ›å»ºè®¢å•ï¼ˆå†™ä¸»åº“ï¼‰"""
        return self.router.execute_write(
            "INSERT INTO orders_0 (...) VALUES (...)",
            order_data
        )
```

### å¤„ç†è¯»å†™å»¶è¿Ÿ

```python
import time
import redis

class OrderServiceWithConsistency:
    def __init__(self):
        self.router = router
        self.redis = redis.Redis(...)

    def create_order(self, order_data):
        """åˆ›å»ºè®¢å•"""
        order_id = self.router.execute_write(
            "INSERT INTO orders_0 (...) VALUES (...)",
            order_data
        )

        # æ ‡è®°è®¢å•å·²åˆ›å»ºï¼ˆç”¨äºåç»­æŸ¥è¯¢ï¼‰
        self.redis.setex(f"order_created:{order_id}", 5, "1")

        return order_id

    def get_order(self, order_id):
        """æŸ¥è¯¢è®¢å•ï¼ˆå¤„ç†è¯»å†™å»¶è¿Ÿï¼‰"""
        # 1. æ£€æŸ¥æ˜¯å¦åˆšåˆ›å»º
        if self.redis.exists(f"order_created:{order_id}"):
            # åˆšåˆ›å»ºï¼Œä»ä¸»åº“è¯»
            conn = self.router.get_connection(read_only=False)
            cursor = conn.cursor(dictionary=True)
            cursor.execute("SELECT * FROM orders_0 WHERE id = %s", (order_id,))
            return cursor.fetchone()

        # 2. å¦åˆ™ä»ä»åº“è¯»
        return self.router.execute_read(
            "SELECT * FROM orders_0 WHERE id = %s",
            (order_id,)
        )
```

---

## æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ä¼˜åŒ–

```sql
-- è®¢å•è¡¨ç´¢å¼•
CREATE INDEX idx_user_status_time ON orders_0(user_id, status, created_at);
CREATE INDEX idx_user_created ON orders_0(user_id, created_at DESC);

-- å•†å“æœç´¢ç´¢å¼•ï¼ˆå…¨æ–‡ï¼‰
CREATE FULLTEXT INDEX ft_name ON products(name) WITH PARSER ngram;
CREATE FULLTEXT INDEX ft_description ON products(description) WITH PARSER ngram;

-- åº“å­˜æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_sku_available ON inventory(sku_id, available_stock);
CREATE INDEX idx_warehouse_sku ON inventory(warehouse_id, sku_id);

-- ä¼˜æƒ åˆ¸æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_user_status_expire ON user_coupons(user_id, status, expire_time);
```

### æŸ¥è¯¢ä¼˜åŒ–

```sql
-- 1. é¿å… SELECT *
-- âŒ æŸ¥è¯¢æ‰€æœ‰åˆ—
SELECT * FROM orders_0 WHERE user_id = 123;

-- âœ… åªæŸ¥è¯¢éœ€è¦çš„åˆ—
SELECT id, order_no, total_amount, status FROM orders_0 WHERE user_id = 123;

-- 2. åˆ†é¡µä¼˜åŒ–
-- âŒ æ·±åˆ†é¡µæ…¢
SELECT * FROM orders_0 WHERE user_id = 123 ORDER BY id DESC LIMIT 100000, 20;

-- âœ… ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆåŸºäºä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§IDï¼‰
SELECT * FROM orders_0
WHERE user_id = 123 AND id < 999999
ORDER BY id DESC LIMIT 20;

-- 3. è¦†ç›–ç´¢å¼•
-- åˆ›å»ºè¦†ç›–ç´¢å¼•
CREATE INDEX idx_user_status ON orders_0(user_id, status);

-- âœ… æŸ¥è¯¢åªä½¿ç”¨ç´¢å¼•ï¼Œæ— éœ€å›è¡¨
SELECT status FROM orders_0 WHERE user_id = 123;

-- 4. æ‰¹é‡æ“ä½œ
-- âŒ é€æ¡æ’å…¥
INSERT INTO order_items_0 (...) VALUES (...);
INSERT INTO order_items_0 (...) VALUES (...);

-- âœ… æ‰¹é‡æ’å…¥
INSERT INTO order_items_0 (...) VALUES (...), (...), (...);
```

### åˆ†åŒºè¡¨

```sql
-- è®¢å•è¡¨æŒ‰æœˆåˆ†åŒº
CREATE TABLE orders_2024 (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    order_no VARCHAR(50) NOT NULL,
    user_id BIGINT UNSIGNED NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    status TINYINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (id, created_at),
    KEY idx_user_id (user_id),
    KEY idx_order_no (order_no)
) ENGINE=InnoDB
PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202401 VALUES LESS THAN (202402),
    PARTITION p202402 VALUES LESS THAN (202403),
    PARTITION p202403 VALUES LESS THAN (202404),
    -- ...
    PARTITION pmax VALUES LESS THAN MAXVALUE
);

-- æŸ¥è¯¢åªæ‰«æå¯¹åº”åˆ†åŒº
SELECT * FROM orders_2024
WHERE created_at >= '2024-02-01'
  AND created_at < '2024-03-01';
```

---

## é¡¹ç›®éƒ¨ç½²

### Docker Compose éƒ¨ç½²

```yaml
version: '3.8'

services:
  # MySQL ä¸»åº“
  mysql-master:
    image: mysql:8.0
    container_name: mysql-master
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: Root@2024
      MYSQL_DATABASE: order_db
    volumes:
      - mysql-master-data:/var/lib/mysql
      - ./mysql/master.cnf:/etc/mysql/conf.d/custom.cnf
    command: --server-id=1 --log-bin=mysql-bin --binlog-format=ROW

  # MySQL ä»åº“
  mysql-slave:
    image: mysql:8.0
    container_name: mysql-slave
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: Root@2024
    volumes:
      - mysql-slave-data:/var/lib/mysql
      - ./mysql/slave.cnf:/etc/mysql/conf.d/custom.cnf
    command: --server-id=2 --relay-log=relay-bin --read-only=1

  # Redis
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: Admin@2024

  # Elasticsearch
  elasticsearch:
    image: elasticsearch:8.10.0
    container_name: elasticsearch
    ports:
      - "9200:9200"
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - es-data:/usr/share/elasticsearch/data

volumes:
  mysql-master-data:
  mysql-slave-data:
  redis-data:
  es-data:
```

### ç›‘æ§éƒ¨ç½²

```bash
# Prometheus + Grafana ç›‘æ§
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  -v ./prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus

docker run -d \
  --name grafana \
  -p 3000:3000 \
  grafana/grafana

# MySQL Exporter
docker run -d \
  --name mysql-exporter \
  -p 9104:9104 \
  -e DATA_SOURCE_NAME="root:Root@2024@(192.168.1.10:3306)/" \
  prom/mysqld-exporter

# Redis Exporter
docker run -d \
  --name redis-exporter \
  -p 9121:9121 \
  -e REDIS_ADDR="redis://192.168.1.20:6379" \
  oliver006/redis_exporter
```

---

## âœ… æœ¬ç« å°ç»“

### å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œè¯·ç¡®è®¤ä½ èƒ½å¤Ÿï¼š

- [ ] åˆ†æç”µå•†ç³»ç»Ÿçš„ä¸šåŠ¡éœ€æ±‚
- [ ] è®¾è®¡å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„
- [ ] å®ç°ä¸‹å•äº‹åŠ¡å¤„ç†
- [ ] è®¾è®¡å¤šçº§ç¼“å­˜æ¶æ„
- [ ] å®ç°è¯»å†™åˆ†ç¦»
- [ ] å¤„ç†é«˜å¹¶å‘åœºæ™¯ï¼ˆç§’æ€ï¼‰
- [ ] ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- [ ] ä½¿ç”¨ Docker Compose éƒ¨ç½²é¡¹ç›®

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

1. **éœ€æ±‚åˆ†æ**ï¼šæ˜ç¡®åŠŸèƒ½éœ€æ±‚å’ŒéåŠŸèƒ½éœ€æ±‚
2. **æ•°æ®åº“è®¾è®¡**ï¼šER å›¾ã€åˆ†åº“åˆ†è¡¨ã€ç´¢å¼•è®¾è®¡
3. **äº‹åŠ¡å¤„ç†**ï¼šACIDã€éš”ç¦»çº§åˆ«ã€æ­»é”å¤„ç†
4. **ç¼“å­˜è®¾è®¡**ï¼šå¤šçº§ç¼“å­˜ã€ç¼“å­˜æ›´æ–°ç­–ç•¥
5. **è¯»å†™åˆ†ç¦»**ï¼šåº”ç”¨å±‚è·¯ç”±ã€ä¸­é—´ä»¶ä»£ç†
6. **æ€§èƒ½ä¼˜åŒ–**ï¼šç´¢å¼•ä¼˜åŒ–ã€æŸ¥è¯¢ä¼˜åŒ–ã€åˆ†åŒºè¡¨
7. **é¡¹ç›®éƒ¨ç½²**ï¼šDocker Composeã€ç›‘æ§å‘Šè­¦

## ğŸ“š å»¶ä¼¸é˜…è¯»

- [ç¬¬3ç« ï¼šMySQL 8.0 å®Œå…¨æŒ‡å— â†’](./chapter-03)
- [ç¬¬6ç« ï¼šRedis ç¼“å­˜è®¾è®¡ä¸å®æˆ˜ â†’](./chapter-05)
- [ç¬¬11ç« ï¼šäº‹åŠ¡ä¸é”æœºåˆ¶ â†’](./chapter-10)
- [ç¬¬12ç« ï¼šä¸»ä»å¤åˆ¶ä¸é«˜å¯ç”¨ â†’](./chapter-11)

**å®Œæ•´é¡¹ç›®ä»£ç **ï¼š
- [GitHub: ç”µå•†æ•°æ®åº“è®¾è®¡å®æˆ˜](https://github.com/your-repo/ecommerce-db)

**æ¨èé˜…è¯»**ï¼š
- [é«˜æ€§èƒ½MySQL](https://www.amazon.com/High-Performance-MySQL-Baron-Schwartz/dp/1449314287)
- [æ•°æ®åº“ç´¢å¼•è®¾è®¡ä¸ä¼˜åŒ–](https://www.amazon.com/dp/7115339706)

---

**æ›´æ–°æ—¶é—´**ï¼š2026å¹´2æœˆ | **ç‰ˆæœ¬**ï¼šv1.0
